<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mobby（モビィ）</title>
  <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Yomogi&display=swap');
    </style>
    
<style>
  :root{
  --color-cream:#FFF8E7;
  --color-forest:#2F4F4F;
  --color-sky:#AEC6CF;
  --color-earth:#8B4513;
  --color-accent-red:#D2691E;
  --color-soft-yellow:#F0E68C;

  /* ここを変更 */
  --font-ja:'Yomogi', cursive;
  --font-en:'Yomogi', cursive;

  --ease-soft:cubic-bezier(0.4, 0.0, 0.2, 1);
}

  *{margin:0;padding:0;box-sizing:border-box;}
  
  body{
    font-family:var(--font-ja);
    background-color:var(--color-cream);
    color:var(--color-forest);
    overflow-x:hidden;
    line-height:1.7;
    overflow-y:hidden; /* splash中 */
  }
  
  #splash-screen.hidden{opacity:0;visibility:hidden;pointer-events:none;}
  
/* Splash */
#splash-screen{
  position:fixed;
  inset:0;
  z-index:9999;
  cursor:pointer;
  transition:opacity 1.2s ease-out, visibility 1.2s ease-out;
  overflow:hidden;

  /* ▼ 小さく表示＋余白は白 */
  background-color:#f9f5f4;                 /* 余白を白に */
  background-image:url('favicon/背景.jpg');
  background-repeat:no-repeat;
  background-position:center;
  background-size: 50% auto;   /* 横幅50%で固定 */
         /* 拡大しない・必ず収まる */
}


/* 暗くするforest色オーバーレイは完全に不要 */
#splash-screen::before{
  display:none;
}



  #splash-screen canvas{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    z-index:1;
  }
  
  .instruction{
    position:absolute;top:60%;left:50%;transform:translateX(-50%);
    color:rgba(255,255,255,0.9);pointer-events:none;
    font-family:var(--font-en), var(--font-ja);font-weight:700;font-size:1rem;
    letter-spacing:0.04em;padding:10px 14px;border-radius:999px;
    background:rgba(255,255,255,0.12);backdrop-filter:blur(8px);
    user-select:none;white-space:nowrap;
    z-index:3;
  }
  
  #main-content{opacity:0;transition:opacity 1.5s ease;}
  #main-content.visible{opacity:1;}
  
  /* モビィタイトル */
  .mobby-title{
    text-align:center;
    font-size:clamp(3.2rem, 5vw, 4.5rem);
    font-weight:700;
    font-family:var(--font-ja);
    color:var(--color-forest);
    letter-spacing:0.15em;
    padding-top:32px;
    padding-bottom:8px;
    opacity:0.95;
    line-height:1;
  }
  @media (max-width: 768px){
    .mobby-title{
      font-size:clamp(3.2rem, 6vw, 3.5rem);
      padding-top:24px;
      padding-bottom:6px;
    }
  }
  
  h1,h2,h3{
    font-family:var(--font-en), var(--font-ja);
    font-weight:700;letter-spacing:0.05em;line-height:1.2;
    color:var(--color-earth);
  }
  p{font-weight:400;letter-spacing:0.02em;}
  .container{max-width:1050px;margin:0 auto;}
  
  .btn{
    display:inline-block;padding:12px 35px;border-radius:255px 15px 225px 15px / 15px 225px 15px 255px;
    text-decoration:none;font-size:16px;font-weight:700;font-family:var(--font-en);
    transition:all 0.4s var(--ease-soft);border:2px solid transparent;
    box-shadow:3px 3px 0 rgba(0,0,0,0.1);cursor:pointer;
  }
  .btn-secondary{background-color:var(--color-cream);color:var(--color-forest);border-color:var(--color-forest);}
  .btn-secondary:hover{background-color:var(--color-sky);color:#fff;border-color:transparent;transform:translateY(-2px) rotate(-1deg);}
  .btn-primary{background-color:var(--color-accent-red);color:var(--color-cream);}
  .btn-primary:hover{background-color:var(--color-earth);transform:translateY(-2px) rotate(1deg);}
  .btn-ghost{background:rgba(255,255,255,0);color:var(--color-forest);border-color:rgba(47,79,79,0.35);}
  .btn-ghost:hover{background:rgba(174,198,207,0.35);border-color:transparent;transform:translateY(-2px);}
  
  .tag{
    display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;
    font-weight:700;letter-spacing:.04em;font-family:var(--font-en), var(--font-ja);
    background:rgba(174,198,207,0.35);color:var(--color-forest);
    border:1px solid rgba(47,79,79,0.18);
  }
  .trust-row{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin-top:16px;}
  .trust-pill{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.7);border:1px solid rgba(47,79,79,0.12);font-weight:700;font-size:0.9rem;}
  
  .reveal{opacity:0;transform:translateY(30px);transition:opacity 1s var(--ease-soft), transform 1s var(--ease-soft);}
  .reveal.active{opacity:1;transform:translateY(0);}
  .delay-200{transition-delay:0.2s;}
  .delay-400{transition-delay:0.4s;}
  
  /* Hero */
  .hero{
    display:flex;flex-direction:column;justify-content:center;align-items:center;
    text-align:center;position:relative;padding-top:10%;padding-bottom:52px;
  }

  .headline{font-size:clamp(2.2rem, 3.9vw, 3.2rem);margin-top:12px;}
  .subhead{margin-top:12px;font-size:1.02rem;opacity:0.92;}
  
  @keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-10px);}}
  .floating{animation:float 4s ease-in-out infinite;}
  
  .cta-row{margin-top:20px;display:flex;flex-wrap:wrap;gap:12px;justify-content:center;}
  .status-row{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:14px;}
  .status-chip{
    display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:18px;
    background:rgba(255,255,255,0.78);border:1px solid rgba(47,79,79,0.12);
    box-shadow:3px 3px 0 rgba(0,0,0,0.06);font-family:var(--font-en), var(--font-ja);font-weight:700;
  }
  .status-chip strong{color:var(--color-earth);}
  
  /* Creator message */
  .hero-quote{
    width:min(920px, 100%);
    margin:0 auto 14px;
    text-align:left;
    border-radius:30px;
    padding:26px 22px;
    background:rgba(255,255,255,0.86);
    border:1px solid rgba(47,79,79,0.14);
    box-shadow:0 18px 45px rgba(0,0,0,0.10);
  }
  /* messagePopup内のhero-quoteのアニメーション */
  #messagePopup .hero-quote{
    opacity:0;
    transform:translateY(20px) scale(0.95);
    transition:opacity 1.2s var(--ease-soft), transform 1.2s var(--ease-soft);
  }
  #messagePopup.is-open .hero-quote{
    opacity:1;
    transform:translateY(0) scale(1);
    transition-delay:0.15s;
  }
  .hero-quote .label{
    font-weight:800;
    color:var(--color-earth);
    font-family:var(--font-en), var(--font-ja);
    margin-bottom:12px;
    letter-spacing:0.08em;
    font-size:1.15rem;
  }
  .hero-quote .creator-text{
    font-size:1.15rem;
    line-height:1.95;
    opacity:0.96;
    min-height:1.95em;
  }
  .hero-quote .creator-text::after{
    content:"|";
    animation:blink 1s infinite;
    margin-left:2px;
  }
  .hero-quote .creator-text.typing-complete::after{
    display:none;
  }
  @keyframes blink{
    0%, 50%{opacity:1;}
    51%, 100%{opacity:0;}
  }
  @media (max-width: 768px){
    .hero-quote{padding:20px 16px;border-radius:26px;}
    .hero-quote .label{font-size:1.05rem;}
    .hero-quote .creator-text{font-size:1.02rem;line-height:1.9;}
  }
  
  /* ===== Hero Carousel (3D Rotating Ring) ===== */
  .hero-carousel{
    width:min(380px, 96vw);
    margin:14px auto 10px;
    position:relative;
    user-select:none;
    touch-action: pan-y pinch-zoom; /* 横スワイプのみカルーセルで処理 */
    perspective: 1300px;
  }
  .carousel-viewport{position:relative;height:276px;overflow: visible;}
  .carousel-track{
    position:absolute;left:50%;top:50%;
    transform-style: preserve-3d;
    transition: transform 0.7s var(--ease-soft);
    will-change: transform;
    backface-visibility: hidden;
  }
  .carousel-slide{
    position:absolute;left:0;top:0;
    width:276px;height:276px;
    transform-style: preserve-3d;
    transition: opacity 0.35s var(--ease-soft), filter 0.35s var(--ease-soft);
    cursor: pointer;
    will-change: transform, opacity;
    backface-visibility: hidden;
  }
  .carousel-slide.dim{opacity: 0.55;filter: blur(0.6px);}
  .hero-illustration{
    width:100%;height:100%;
    background: transparent;border: none;border-radius: 20px;
    overflow: hidden;
    position: relative;
  }
  .hero-illustration img{width:100%;height:100%;object-fit: cover;}
  
  /* カルーセル内のホットスポット */
  .carousel-eye-hotspot{
    position:absolute;
    top:25%;
    left:58%;
    width:22%;
    min-width:52px;
    height:auto;
    min-height:52px;
    aspect-ratio:1/1;
    border-radius:50%;
    background:rgba(255,255,255,0.01);
    border:none;
    cursor:pointer;
    z-index:15;
    pointer-events:auto;
    transform:translateZ(0);
  }
  .carousel-eye-hotspot:hover{outline:2px solid rgba(255,255,255,0.4);}
  .carousel-eye-hotspot::before{
    content:"";
    position:absolute;
    inset:-18%;
    border-radius:50%;
    border:2px dashed rgba(255,255,255,0.65);
    animation:pulse 2.2s ease-in-out infinite;
  }
  .carousel-eye-shutter{
    position:absolute;
    top:34%;
    left:58%;
    width:22%;
    aspect-ratio:1/1;
    border-radius:50%;
    pointer-events:none;
    z-index:16;
    background:
      conic-gradient(
        from 0deg,
        #111 0 10%,
        #222 10% 20%,
        #111 20% 30%,
        #222 30% 40%,
        #111 40% 50%,
        #222 50% 60%,
        #111 60% 70%,
        #222 70% 80%,
        #111 80% 90%,
        #222 90% 100%
      );
    transform:scale(0);
    opacity:0;
  }
  .carousel-eye-shutter.play{animation: shutter 220ms ease-in-out forwards;}
  
  .carousel-btn{
    position:absolute;top:50%;transform:translateY(-50%);
    width:44px;height:44px;border-radius:999px;
    border:1px solid rgba(47,79,79,0.18);
    background:rgba(255,255,255,0.75);
    color:var(--color-forest);
    font-size:26px;font-weight:700;
    cursor:pointer;z-index:10;
    display:flex;align-items:center;justify-content:center;
    transition:transform .2s var(--ease-soft), background .2s var(--ease-soft);
    box-shadow:3px 3px 0 rgba(0,0,0,0.06);
  }
  .carousel-btn:hover{transform:translateY(-50%) scale(1.04);background:rgba(255,255,255,0.88);}
  .carousel-btn.prev{left:-10px;}
  .carousel-btn.next{right:-10px;}
  
  /* カルーセル右上のタップヒント */
  .carousel-tap-hint{
    position:absolute;
    top:8px;
    right:8px;
    font-size:0.75rem;
    font-weight:700;
    color:var(--color-forest);
    background:rgba(255,255,255,0.85);
    border:1px solid rgba(47,79,79,0.15);
    padding:4px 10px;
    border-radius:12px;
    box-shadow:2px 2px 0 rgba(0,0,0,0.05);
    z-index:20;
    pointer-events:none;
    font-family:var(--font-ja);
    letter-spacing:0.05em;
    animation: tapHintPulse 2s ease-in-out infinite;
    opacity:0.9;
  }
  @keyframes tapHintPulse{
    0%, 100%{transform:scale(1);opacity:0.9;}
    50%{transform:scale(1.05);opacity:1;}
  }
  @media (max-width: 768px){
    .carousel-tap-hint{
      font-size:0.7rem;
      padding:3px 8px;
      top: 12%;
      right: 12%;
    }
  }
  
  .carousel-caption{
    margin-top:10px;display:inline-block;
    font-family:var(--font-en), var(--font-ja);
    font-weight:700;color:var(--color-forest);
    background:rgba(255,255,255,0.78);
    border:1px solid rgba(47,79,79,0.12);
    box-shadow:3px 3px 0 rgba(0,0,0,0.04);
    padding:6px 10px;border-radius:999px;
  }
  .carousel-dots{display:flex;justify-content:center;gap:8px;margin-top:10px;}
  .carousel-dot{
    width:10px;height:10px;border-radius:999px;
    border:1px solid rgba(47,79,79,0.18);
    background:rgba(255,255,255,0.55);
    cursor:pointer;
  }
  .carousel-dot.active{background:rgba(240,230,140,0.75);border-color:rgba(240,230,140,0.95);}
  @media (max-width: 768px){
    .carousel-viewport{height:209px;}
    .carousel-slide{width:209px;height:209px;}
    .carousel-btn{width:40px;height:40px;font-size:24px;}
  }
  
  /* Sections */
  .section.center{text-align:center;}
  .lead{margin-top:14px;font-size:1.0rem;opacity:0.92;}
  
  .grid-3{display:grid;grid-template-columns:repeat(3, minmax(0, 1fr));gap:18px;margin-top:24px;}
  .card{
    background:rgba(255,255,255,0.85);border:1px solid rgba(47,79,79,0.12);
    border-radius:26px;padding:18px 16px;box-shadow:3px 3px 0 rgba(0,0,0,0.06);text-align:left;
  }
  .card h3{font-size:1.1rem;margin-bottom:6px;}
  .card p{font-size:0.95rem;opacity:0.92;}
  
  /* Colors */
  #colors{scroll-margin-top:90px;}
  .colors-grid{
    display:grid;grid-template-columns:repeat(4, minmax(0, 1fr));
    gap:14px;margin-top:18px;text-align:left;
  }
  .color-card{
    border-radius:26px;padding:8px 14px;border:1px solid rgba(47,79,79,0.14);
    background:rgba(255,255,255,0.86);box-shadow:3px 3px 0 rgba(0,0,0,0.06);
    cursor:pointer;transition:transform .25s var(--ease-soft), box-shadow .25s var(--ease-soft), border-color .25s var(--ease-soft);
    position:relative;user-select:none;outline:none;
  }
  .color-card:hover{transform:translateY(-2px);}
  .color-card.selected{
    border-color:rgba(210,105,30,0.55);
    box-shadow:0 14px 30px rgba(0,0,0,0.12);
    transform:translateY(-3px);
  }
  .selected-badge{
    position:absolute;top:12px;right:12px;padding:6px 10px;border-radius:999px;
    font-weight:700;font-size:.85rem;background:rgba(240,230,140,0.55);
    border:1px solid rgba(139,69,19,0.18);color:var(--color-earth);display:none;
  }
  .color-card.selected .selected-badge{display:inline-block;}
  .swatch{
    width:36px;height:36px;border-radius:999px;border:2px solid rgba(47,79,79,0.18);
    box-shadow:inset 0 0 0 3px rgba(255,255,255,0.65);margin-bottom:4px;
  }
  .color-card-content{
    display:flex;
    gap:10px;
    align-items:center;
    margin:6px 0 2px;
  }
  .color-title{
    font-weight:700;font-family:var(--font-en), var(--font-ja);color:var(--color-earth);
    display:flex;align-items:center;gap:6px;flex-wrap:wrap;
    font-size:0.95rem;
    flex:1;
  }
  .mini-tag{
    display:inline-block;padding:5px 9px;border-radius:999px;font-size:.85rem;font-weight:700;
    background:rgba(174,198,207,0.25);border:1px solid rgba(47,79,79,0.12);
    color:var(--color-forest);white-space:nowrap;
  }
  .color-desc{margin-top:4px;font-size:.85rem;opacity:.9;}
  .product-thumb{
    width:70px;
    height:70px;
    border-radius:12px;
    border:1px solid rgba(47,79,79,0.12);
    box-shadow:0 8px 20px rgba(0,0,0,0.06);
    object-fit:cover;background:#fff;
    flex-shrink:0;
  }
  
  .steps{display:grid;grid-template-columns:repeat(3, minmax(0, 1fr));gap:18px;margin-top:26px;text-align:left;}
  .step{position:relative;overflow:hidden;}
  .step .num{font-family:var(--font-en);font-size:2.1rem;font-weight:700;opacity:0.18;position:absolute;top:8px;right:14px;}
  .step .title{font-weight:700;font-family:var(--font-en), var(--font-ja);color:var(--color-earth);margin-bottom:6px;font-size:1.05rem;}
  .step .mini{font-size:0.95rem;opacity:0.92;}
  
  .pricing{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:18px;text-align:left;}
  .price-card{
    border-radius:26px;padding:18px 16px;border:1px solid rgba(47,79,79,0.12);
    background:rgba(255,255,255,0.86);box-shadow:3px 3px 0 rgba(0,0,0,0.06);
  }
  .price-card .label{
    font-weight:700;font-family:var(--font-en), var(--font-ja);color:var(--color-earth);
    display:flex;align-items:center;gap:10px;
  }
  .price-card .value{font-size:1.6rem;font-weight:700;margin-top:10px;color:var(--color-forest);font-family:var(--font-en), var(--font-ja);}
  .badge{
    display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:0.85rem;
    background:rgba(240,230,140,0.45);border:1px solid rgba(139,69,19,0.18);
    color:var(--color-earth);white-space:nowrap;
  }
  
  .notice{
    margin-top:14px;padding:12px 14px;border-radius:18px;background:rgba(255,248,231,0.75);
    border:1px dashed rgba(139,69,19,0.25);font-size:0.92rem;text-align:left;
  }
  
  .buy-preview{
    max-width:820px;margin:14px auto 0;
    display:flex;gap:14px;align-items:center;justify-content:center;flex-wrap:wrap;
  }
  .buy-preview img{
    width:140px;height:140px;border-radius:22px;object-fit:cover;
    border:1px solid rgba(47,79,79,0.12);
    box-shadow:0 12px 25px rgba(0,0,0,0.08);
    background:#fff;
  }
  
  /* FAQ */
  .faq{margin-top:18px;text-align:left;}
  details.faq-item{
    background:rgba(255,255,255,0.84);border:1px solid rgba(47,79,79,0.12);
    border-radius:18px;padding:14px 14px;margin-top:10px;box-shadow:3px 3px 0 rgba(0,0,0,0.04);
  }
  details.faq-item summary{cursor:pointer;font-weight:700;color:var(--color-earth);font-family:var(--font-en), var(--font-ja);list-style:none;}
  details.faq-item summary::-webkit-details-marker{display:none;}
  details.faq-item p{margin-top:10px;opacity:0.92;}
  
  /* FAQお問い合わせフォーム */
  .faq-contact-form{
    background:rgba(255,255,255,0.88);border:1px solid rgba(47,79,79,0.14);
    border-radius:22px;padding:24px 20px;box-shadow:3px 3px 0 rgba(0,0,0,0.05);
  }
  .faq-contact-form input:focus,
  .faq-contact-form textarea:focus{
    border-color:rgba(210,105,30,0.4);
    box-shadow:0 0 0 3px rgba(210,105,30,0.1);
  }
  
  /* 値段ポップアップの抽選予約フォーム */
  .price-reservation-form{
    background:rgba(255,255,255,0.88);border:1px solid rgba(47,79,79,0.14);
    border-radius:22px;padding:24px 20px;box-shadow:3px 3px 0 rgba(0,0,0,0.05);
  }
  .price-reservation-form input:focus,
  .price-reservation-form textarea:focus{
    border-color:rgba(210,105,30,0.4);
    box-shadow:0 0 0 3px rgba(210,105,30,0.1);
  }
  
  /* Sticky CTA */
  .sticky-cta{
    position:fixed;left:0;right:0;bottom:12px;z-index:50;display:none;pointer-events:none;
  }
  .sticky-cta .inner{max-width:1050px;margin:0 auto;padding:0 16px;display:flex;justify-content:center;}
  .sticky-cta .bar{
    pointer-events:auto;width:min(900px, 100%);background:rgba(255,255,255,0.82);
    border:1px solid rgba(47,79,79,0.16);backdrop-filter:blur(10px);border-radius:999px;
    padding:10px 12px;box-shadow:0 12px 30px rgba(0,0,0,0.12);
    display:flex;gap:10px;align-items:center;justify-content:space-between;
  }
  .sticky-cta .txt{font-weight:700;font-family:var(--font-en), var(--font-ja);color:var(--color-forest);padding-left:6px;font-size:0.95rem;}
  .sticky-cta .btn{padding:10px 18px;font-size:0.95rem;}
  
  footer{background-color:var(--color-forest);padding:56px 0;text-align:center;color:var(--color-cream);}
  .footer-links a{color:var(--color-sky);text-decoration:none;margin:0 12px;font-weight:700;}
  
  /* ポップアップボタンバー（最下部） */
  .popup-buttons-bar{
    background-color:var(--color-cream);
    padding:24px 0;
  }
  .popup-buttons{
    display:flex;
    flex-wrap:nowrap;
    gap:12px;
    justify-content:center;
    align-items:center;
  }
  .popup-buttons .btn{
    width:50px;
    height:50px;
    padding:0;
    display:flex;
    align-items:center;
    justify-content:center;
    aspect-ratio:1/1;
    border-radius:18px;
  }
  
  /* ポップアップオーバーレイ */
  .popup-overlay{
    position:fixed;
    inset:0;
    z-index:99998;
    display:none;
    background:rgba(47,79,79,0.85);
    backdrop-filter:blur(4px);
    overflow-y:auto;
    padding:20px;
  }
  .popup-overlay.is-open{
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .popup-content{
    position:relative;
    background:var(--color-cream);
    border-radius:30px;
    padding:40px 30px;
    max-width:900px;
    width:100%;
    max-height:90vh;
    overflow-y:auto;
    box-shadow:0 20px 60px rgba(0,0,0,0.3);
    margin:auto;
  }
  .popup-close{
    position:absolute;
    top:16px;
    right:16px;
    width:44px;
    height:44px;
    border-radius:999px;
    border:2px solid rgba(47,79,79,0.18);
    background:rgba(255,255,255,0.85);
    color:var(--color-forest);
    font-size:28px;
    font-weight:700;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:all 0.2s var(--ease-soft);
    z-index:10;
  }
  .popup-close:hover{
    background:rgba(174,198,207,0.35);
    transform:scale(1.05);
  }
  @media (max-width: 768px){
    .popup-content{
      padding:30px 20px;
      border-radius:24px;
    }
    .popup-buttons{
      flex-wrap:wrap;
      gap:10px;
    }
    .popup-buttons .btn{
      width:50px;
      height:50px;
      max-width:none;
    }
  }
  
  /* ===== Image Gallery (Apple-style) ===== */
  .image-gallery-popup{
    padding:0;
    max-width:95vw;
    max-height:95vh;
    overflow:hidden;
    background:rgba(0,0,0,0.95);
    border-radius:20px;
  }
  .image-gallery-container{
    position:relative;
    width:100%;
    height:100%;
    min-height:70vh;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
  }
  .image-gallery-viewport{
    position:relative;
    width:100%;
    height:100%;
    overflow:hidden;
    touch-action:pan-y pinch-zoom;
  }
  .image-gallery-track{
    display:flex;
    height:100%;
    transition:transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    will-change:transform;
  }
  .image-gallery-slide{
    min-width:100%;
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:60px 40px;
    box-sizing:border-box;
  }
  .gallery-image{
    max-width:100%;
    max-height:100%;
    width:auto;
    height:auto;
    object-fit:contain;
    border-radius:12px;
    box-shadow:0 20px 60px rgba(0,0,0,0.5);
    user-select:none;
    -webkit-user-drag:none;
    transition:transform 0.3s ease;
  }
  .gallery-image:hover{
    transform:scale(1.02);
  }
  .image-gallery-controls{
    position:absolute;
    top:50%;
    left:0;
    right:0;
    transform:translateY(-50%);
    display:flex;
    justify-content:space-between;
    padding:0 20px;
    pointer-events:none;
    z-index:10;
  }
  .gallery-nav-btn{
    width:50px;
    height:50px;
    border-radius:50%;
    border:none;
    background:rgba(255,255,255,0.15);
    backdrop-filter:blur(20px);
    color:#fff;
    font-size:28px;
    font-weight:300;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    pointer-events:auto;
    box-shadow:0 4px 20px rgba(0,0,0,0.2);
  }
  .gallery-nav-btn:hover{
    background:rgba(255,255,255,0.25);
    transform:scale(1.1);
  }
  .gallery-nav-btn:active{
    transform:scale(0.95);
  }
  .image-gallery-indicator{
    position:absolute;
    bottom:30px;
    left:50%;
    transform:translateX(-50%);
    display:flex;
    gap:10px;
    z-index:10;
    padding:8px 16px;
    background:rgba(0,0,0,0.4);
    backdrop-filter:blur(20px);
    border-radius:999px;
  }
  .indicator-dot{
    width:8px;
    height:8px;
    border-radius:50%;
    background:rgba(255,255,255,0.4);
    cursor:pointer;
    transition:all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  .indicator-dot.active{
    background:rgba(255,255,255,0.95);
    width:24px;
    border-radius:4px;
  }
  .indicator-dot:hover{
    background:rgba(255,255,255,0.7);
  }
  @media (max-width: 768px){
    .image-gallery-popup{
      max-width:100vw;
      max-height:100vh;
      border-radius:0;
    }
    .image-gallery-container{
      min-height:100vh;
    }
    .image-gallery-slide{
      padding:80px 20px 100px;
    }
    .gallery-nav-btn{
      width:44px;
      height:44px;
      font-size:24px;
    }
    .image-gallery-controls{
      padding:0 10px;
    }
    .image-gallery-indicator{
      bottom:20px;
    }
    .gallery-image{
      border-radius:8px;
    }
  }
  
  @media (max-width: 900px){
    .pricing{grid-template-columns:1fr;}
    .colors-grid{grid-template-columns:repeat(2, minmax(0, 1fr));}
  }
  @media (max-width: 768px){
    .hero-carousel{width:min(266px, 92vw);}
    .grid-3,.steps{grid-template-columns:1fr;}
    .colors-grid{grid-template-columns:1fr;}
    .sticky-cta .txt{display:none;}
    .sticky-cta .bar{justify-content:center;}
  }
  
  /* ===== TRY DEMO ===== */
  .try-wrap{max-width:860px;margin:18px auto 0;}
  .try-card{
    width:100%;
    border:1px solid rgba(47,79,79,0.12);
    background:rgba(255,255,255,0.86);
    border-radius:26px;
    padding:14px;
    box-shadow:3px 3px 0 rgba(0,0,0,0.06);
    cursor:pointer;
    text-align:left;
    transition:transform .25s var(--ease-soft), box-shadow .25s var(--ease-soft);
    position:relative;
  }
  .try-card:hover{transform:translateY(-2px);box-shadow:0 14px 30px rgba(0,0,0,0.12);}
  .try-img{
    width:100%;
    height:auto;
    border-radius:18px;
    display:block;
    border:1px solid rgba(47,79,79,0.10);
    box-shadow:0 12px 25px rgba(0,0,0,0.08);
    background:#fff;
  }
  .try-badge{
    position:absolute;top:24px;right:24px;
    padding:6px 10px;border-radius:999px;
    font-weight:800;font-family:var(--font-en), var(--font-ja);
    background:rgba(0,0,0,0.45);color:#fff;
    border:1px solid rgba(255,255,255,0.18);
  }
  .try-text{margin-top:12px;}
  .try-title{font-weight:800;color:var(--color-earth);font-family:var(--font-en), var(--font-ja);}
  .try-sub{font-size:.95rem;opacity:.85;margin-top:4px;}
  
  /* ===== Overlay base ===== */
  .vf{
    position:fixed;inset:0;z-index:99999;
    display:none;color:var(--color-cream);
  }
  .vf.is-open{display:block;}
  .vf-backdrop{
    position:absolute;inset:0;
    background:rgba(47,79,79,0.78);
    backdrop-filter: blur(2px);
    z-index:1;
  }
  .vf-top, .vf-footer, .vf-stage{ position: relative; z-index: 2; }
  
  .vf-top{
    display:flex;justify-content:space-between;gap:12px;
    padding:14px 16px;
  }
  .vf-meta{display:grid;gap:4px;}
  .vf-counter{
    font-weight:900;letter-spacing:.04em;
    font-family:var(--font-en), var(--font-ja);
    color:var(--color-soft-yellow);
  }
  .vf-sub{font-size:12px;opacity:.85;max-width:72ch;}
  .vf-close{min-width:52px;min-height:44px;display:flex;align-items:center;justify-content:center;}
  .vf-footer{
    position:absolute;left:50%;bottom:18px;
    transform:translateX(-50%);
  }
  .vf-tip{
    display:inline-block;
    padding:8px 12px;border-radius:999px;
    background:rgba(255,255,255,0.12);
    border:1px solid rgba(255,255,255,0.14);
    font-size:12px;opacity:.95;
    backdrop-filter: blur(10px);
    white-space:nowrap;
  }
  @media (max-width:768px){
    .vf-tip{white-space:normal;text-align:center;}
  }
  
  /* ===== Eye tap (right eye hotspot) ===== */
  .eye-tap-wrap{
    position:relative;
    width:260px;
    margin:0 auto;
  }
  .eye-tap-img{width:100%;height:auto;display:block;}
  
  .eye-hotspot{
    position:absolute;
    top:25%;
    left:58%;
    width:22%;
    aspect-ratio:1/1;
    border-radius:50%;
    background:rgba(255,255,255,0.01);
    border:none;
    cursor:pointer;
    z-index:3;
  }
  .eye-hotspot:hover{outline:2px solid rgba(255,255,255,0.4);}
  .eye-hotspot::before{
    content:"";
    position:absolute;
    inset:-18%;
    border-radius:50%;
    border:2px dashed rgba(255,255,255,0.65);
    animation:pulse 2.2s ease-in-out infinite;
  }
  .eye-hint{
    position:absolute;
    top:26%;
    left:58%;
    transform:translate(-50%, -100%);
    font-size:0.8rem;
    font-weight:700;
    padding:6px 10px;
    border-radius:999px;
    background:rgba(0,0,0,0.55);
    color:#fff;
    white-space:nowrap;
    z-index:4;
  }
  @keyframes pulse{
    0%{transform:scale(0.9);opacity:0.2;}
    50%{transform:scale(1.05);opacity:0.8;}
    100%{transform:scale(0.9);opacity:0.2;}
  }
  
  /* ===== Eye Shutter ===== */
  .eye-shutter{
    position:absolute;
    top:34%;
    left:58%;
    width:22%;
    aspect-ratio:1/1;
    border-radius:50%;
    pointer-events:none;
    z-index:5;
    background:
      conic-gradient(
        from 0deg,
        #111 0 10%,
        #222 10% 20%,
        #111 20% 30%,
        #222 30% 40%,
        #111 40% 50%,
        #222 50% 60%,
        #111 60% 70%,
        #222 70% 80%,
        #111 80% 90%,
        #222 90% 100%
      );
    transform:scale(0);
    opacity:0;
  }
  .eye-shutter.play{animation: shutter 220ms ease-in-out forwards;}
  @keyframes shutter{
    0%{transform:scale(0.1);opacity:0;}
    40%{transform:scale(1.05);opacity:1;}
    70%{transform:scale(0.95);opacity:1;}
    100%{transform:scale(0);opacity:0;}
  }
  
  /* ===== Retro Camera (Overlay内) ===== */
  #vfOverlay .vf-stage{
    position:relative;
    z-index:2;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:14px;
    padding: 8px 16px 22px;
    height: calc(100vh - 64px);
  }
  
  #vfOverlay .rc-camera-body{
    position:relative;
    width:min(86vw, 520px);
    aspect-ratio:1/1;
    background:#1a1a1c;
    box-shadow: inset 0 0 50px #000;
    border-radius:8px;
    overflow:hidden;
    background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.06'/%3E%3C/svg%3E");
  }
  
  #vfOverlay .rc-viewfinder{
    position:absolute;
    inset: 8.5%;
    background:#050505;
    box-shadow: inset 0 0 80px rgba(0,0,0,1);
    overflow:hidden;
    perspective: 1000px;
    border-radius:6px;
  }
  
  /* うっすら夜プリ系の色ムード */
  #vfOverlay .rc-viewfinder::after{
    content:"";
    position:absolute; inset:0;
    background: linear-gradient(180deg, rgba(255,200,220,0.07), rgba(140,160,255,0.06));
    mix-blend-mode: screen;
    pointer-events:none;
    z-index:90;
  }
  
  #vfOverlay .rc-photo-layer{
    position:absolute;
    inset:0;
    z-index:10;
  }
  
  #vfOverlay .rc-polaroid{
    position:absolute;
    background:#fdfbf7;
    padding:10px 10px 10px 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.6);
    transition: all 0.8s cubic-bezier(0.25, 0.8, 0.25, 1);
    width: 30%;
    height: 30%;
    will-change: transform, opacity, filter;
    border-radius: 2px 3px 4px 2px;
  }
  #vfOverlay .rc-polaroid img{
    display:block;
    width:100%;
    height:100%;
    object-fit:cover;
    user-select:none;
    -webkit-user-drag:none;
  
    /* “エモ”フィルム寄せ */
    filter:
      contrast(1.15)
      brightness(0.95)
      saturate(1.15)
      sepia(0.18)
      hue-rotate(-4deg);
  }
  
  /* 粒子 */
  #vfOverlay .rc-polaroid::after{
    content:"";
    position:absolute;
    inset:0;
    background:
      url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.08'/%3E%3C/svg%3E");
    mix-blend-mode: overlay;
    pointer-events:none;
  }
  
  /* age states */
  #vfOverlay .rc-age-0{
    top:50%; left:50%;
    transform: translate(-50%, -50%) rotate(1.5deg) scale(1.12);
    z-index:50; opacity:1;
    filter: contrast(1.1) brightness(1.05);
    box-shadow: 0 22px 60px rgba(0,0,0,0.92);
  }
  #vfOverlay .rc-age-1{
    top: 8%; left: 6%;
    transform: rotate(-6deg) scale(0.95);
    z-index:40; opacity:0.95;
    filter: sepia(0.2) contrast(1);
  }
  #vfOverlay .rc-age-2{
    top: 6%; right: 6%;
    transform: rotate(4deg) scale(0.90);
    z-index:30; opacity:0.85;
    filter: sepia(0.4) brightness(0.9);
  }
  #vfOverlay .rc-age-3{
    bottom: 10%; left: 7%;
    transform: rotate(8deg) scale(0.85);
    z-index:20; opacity:0.7;
    filter: sepia(0.6) grayscale(0.45) brightness(0.82);
  }
  #vfOverlay .rc-age-4{
    bottom: 7%; right: 5%;
    transform: rotate(-5deg) scale(0.80);
    z-index:10; opacity:0.4;
    filter: sepia(0.82) grayscale(0.8) blur(2px);
  }
  
  /* overlays */
  #vfOverlay .rc-overlay-texture{
    position:absolute; inset:0;
    pointer-events:none;
    z-index:100;
    mix-blend-mode:overlay;
    opacity:0.55;
    background: radial-gradient(circle, transparent 30%, #000 130%);
  }
  #vfOverlay .rc-dust{
    position:absolute;
    background: rgba(255, 255, 255, 0.45);
    border-radius:50%;
    pointer-events:none;
    z-index:101;
  }
  #vfOverlay .rc-lens-reflection{
    position:absolute;
    bottom:-80px; left:50%;
    transform:translateX(-50%);
    width:80%; height:150px;
    background: radial-gradient(ellipse at center, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0) 70%);
    border-radius:50%;
    z-index:110;
    border-top: 1px solid rgba(255,255,255,0.12);
    filter: blur(2px);
    pointer-events:none;
  }
  
  #vfOverlay .rc-controls{
    text-align:center;
    display:grid;
    gap:10px;
  }
  #vfOverlay .rc-snap{
    background:#cc3333;
    color:#fff;
    border:none;
    padding:12px 24px;
    font-size:16px;
    border-radius:30px;
    cursor:pointer;
    box-shadow:0 6px 16px rgba(204, 51, 51, 0.38);
    font-family: var(--font-en), var(--font-ja);
    font-weight:900;
    letter-spacing:0.10em;
  }
  #vfOverlay .rc-snap:active{ transform: scale(0.97); background:#aa2222; }
  #vfOverlay .rc-hint{
    font-size:12px;
    opacity:0.82;
    color: rgba(255,255,255,0.82);
  }
  

</style>
</head>

<body>
  <!-- Splash -->
  <div id="splash-screen">
    <div class="instruction">TAP！！</div>
  </div>

  <div id="main-content">
    <div class="mobby-title">モビィ</div>
    <section class="hero">
      <div class="container reveal">



        <!-- 4色カルーセル -->
        <div class="hero-carousel floating reveal delay-200" id="heroCarousel" aria-label="Mobby カラーギャラリー">
          <div class="carousel-tap-hint">タップ</div>
          <button class="carousel-btn prev" type="button" aria-label="前の色">‹</button>

          <div class="carousel-viewport">
            <div class="carousel-track" id="heroTrack">
              <div class="carousel-slide" data-color="pink">
                <div class="hero-illustration"><img src="mobby_pink.jpg" alt="Mobby Peach Pink"></div>
              </div>
              <div class="carousel-slide" data-color="purple">
                <div class="hero-illustration"><img src="mobby_purple.jpg" alt="Mobby Twilight Violet"></div>
              </div>
              <div class="carousel-slide" data-color="blue">
                <div class="hero-illustration"><img src="mobby_blue.jpg" alt="Mobby Aqua Sky"></div>
              </div>
              <div class="carousel-slide" data-color="orange">
                <div class="hero-illustration"><img src="mobby_orange.jpg" alt="Mobby Sunny Orange"></div>
              </div>
            </div>
          </div>

          <button class="carousel-btn next" type="button" aria-label="次の色">›</button>

          <div class="carousel-caption" id="heroCaption">Peach Pink</div>
        </div>

        <h1 class="headline reveal delay-200">閉じ込めたい<br>５つの思い出</h1>
      </div>
    </section>


<!-- Viewfinder Overlay -->

<div id="vfOverlay" class="vf" aria-hidden="true">
  <div class="vf-top">
    <div class="vf-meta">
      <div class="vf-counter" id="vfCounter">5 / 5</div>
      <div class="vf-sub">新しい写真を撮ると、古い写真は隅へ。いっぱいになったら選んで削除するビィ</div>
    </div>
    <button class="btn btn-ghost vf-close" id="vfClose" type="button" aria-label="閉じる">×</button>
  </div>

  <div class="vf-backdrop" id="vfBackdrop"></div>

  <!-- ★ Retro Camera 本体 -->
  <div class="vf-stage" role="application" aria-label="Retro Camera Demo">
    <div class="rc-camera-body">
      <div class="rc-viewfinder" id="rcViewfinder">
        <div class="rc-photo-layer" id="rcPhotoContainer"></div>
        <div class="rc-overlay-texture"></div>
        <div class="rc-lens-reflection"></div>
      </div>
    </div>

    <div class="rc-controls">
      <button class="rc-snap" id="rcSnap" type="button" aria-label="シャッター">SNAP SHUTTER</button>
      <div class="rc-hint">いっぱい残せない。だから、残るのは今の5つだけ。</div>
    </div>
  </div>
</div>


    <!-- COLORS ポップアップ -->
    <div id="colorsPopup" class="popup-overlay" aria-hidden="true">
      <div class="popup-content">
        <button class="popup-close" id="closeColorsPopup" aria-label="閉じる">×</button>
        <div class="container">
          <h2>4色</h2>
          <p class="lead">雰囲気で選べる。</p>

          <div class="colors-grid reveal delay-200" role="list">
            <div class="color-card selected" role="listitem" tabindex="0" data-color="pink">
              <div class="selected-badge">選択中</div>
              <div class="swatch" style="background:#F7A7C6;"></div>
              <div class="color-card-content">
                <img class="product-thumb" src="mobby_pink.jpg" alt="Mobby Peach Pink">
                <div class="color-title">Peach Pink <span class="mini-tag">直感</span></div>
              </div>
              <div class="color-desc">好きに正直。</div>
            </div>

            <div class="color-card" role="listitem" tabindex="0" data-color="purple">
              <div class="selected-badge">選択中</div>
              <div class="swatch" style="background:#9C7BFF;"></div>
              <div class="color-card-content">
                <img class="product-thumb" src="mobby_purple.jpg" alt="Mobby Twilight Violet">
                <div class="color-title">Twilight Violet <span class="mini-tag">世界観</span></div>
              </div>
              <div class="color-desc">こだわり強め。</div>
            </div>

            <div class="color-card" role="listitem" tabindex="0" data-color="blue">
              <div class="selected-badge">選択中</div>
              <div class="swatch" style="background:#8FD7FF;"></div>
              <div class="color-card-content">
                <img class="product-thumb" src="mobby_blue.jpg" alt="Mobby Aqua Sky">
                <div class="color-title">Aqua Sky <span class="mini-tag">冒険</span></div>
              </div>
              <div class="color-desc">フッ軽。</div>
            </div>

            <div class="color-card" role="listitem" tabindex="0" data-color="orange">
              <div class="selected-badge">選択中</div>
              <div class="swatch" style="background:#FFA24A;"></div>
              <div class="color-card-content">
                <img class="product-thumb" src="mobby_orange.jpg" alt="Mobby Sunny Orange">
                <div class="color-title">Sunny Orange <span class="mini-tag">勇気</span></div>
              </div>
              <div class="color-desc">前に進める。</div>
            </div>
          </div>

          <div class="notice reveal delay-200">
            <strong>選択中：</strong><span id="selectedColorText">Peach Pink</span>
          </div>

          <div class="cta-row reveal delay-200" style="margin-top:16px;">
            <button class="btn btn-ghost" id="openPriceFromColors">値段</button>
          </div>
        </div>
      </div>
    </div>


    <!-- PRICE ポップアップ -->
    <div id="pricePopup" class="popup-overlay" aria-hidden="true">
      <div class="popup-content">
        <button class="popup-close" id="closePricePopup" aria-label="閉じる">×</button>
        <div class="container">
          <h2>値段</h2>
          <p class="lead">卒業式までセール！ビィ</p>

          <div class="pricing reveal delay-200">
            <div class="price-card">
              <div class="label">通常 <span class="badge">¥8,000</span></div>
              <div class="value">¥5,000</div>
            </div>
          </div>

          <!-- 抽選予約フォーム -->
          <div class="price-reservation-form reveal delay-200" style="margin-top:32px;">
            <h3 style="font-size:1.2rem;margin-bottom:12px;color:var(--color-forest);">購入の抽選予約</h3>
            <p style="font-size:0.9rem;opacity:0.85;margin-bottom:20px;line-height:1.6;">
              抽選に当たったら、当選の手紙を送るビィ。<br>
              住所を入力して予約してビィ。
            </p>
            <form id="priceReservationForm">
              <div class="form-group">
                <label for="reservationAddress" style="display:block;margin-bottom:6px;font-weight:700;color:var(--color-earth);font-size:0.95rem;">住所 <span style="color:rgba(47,79,79,0.6);font-size:0.85rem;">（必須）</span></label>
                <textarea 
                  id="reservationAddress" 
                  name="address" 
                  required 
                  rows="4"
                  placeholder="郵便番号、都道府県、市区町村、番地、建物名などをご記入ください"
                  style="width:100%;padding:12px 14px;border-radius:18px;border:1px solid rgba(47,79,79,0.18);background:rgba(255,255,255,0.9);font-size:0.95rem;font-family:var(--font-ja);outline:none;resize:vertical;transition:border-color 0.2s;"
                ></textarea>
              </div>
              
              <div style="margin-top:20px;padding-top:20px;border-top:1px dashed rgba(47,79,79,0.15);">
                <p style="font-size:0.85rem;opacity:0.75;margin-bottom:16px;">住所が間違えてたら連絡するビィ</p>
                <p style="font-size:0.85rem;opacity:0.75;margin-bottom:16px;">入力してくれたら嬉しいビィ</p>
                
                <div class="form-group" style="margin-top:16px;">
                  <label for="reservationName" style="display:block;margin-bottom:6px;font-weight:700;color:var(--color-earth);font-size:0.95rem;">名前 <span style="color:rgba(47,79,79,0.5);font-size:0.85rem;">（任意）</span></label>
                  <input 
                    type="text" 
                    id="reservationName" 
                    name="name" 
                    placeholder="お名前"
                    style="width:100%;padding:12px 14px;border-radius:18px;border:1px solid rgba(47,79,79,0.18);background:rgba(255,255,255,0.9);font-size:0.95rem;font-family:var(--font-ja);outline:none;transition:border-color 0.2s;"
                  />
                </div>
                
                <div class="form-group" style="margin-top:16px;">
                  <label for="reservationEmail" style="display:block;margin-bottom:6px;font-weight:700;color:var(--color-earth);font-size:0.95rem;">メールアドレス <span style="color:rgba(47,79,79,0.5);font-size:0.85rem;">（任意）</span></label>
                  <input 
                    type="email" 
                    id="reservationEmail" 
                    name="email" 
                    placeholder="your.email@example.com"
                    style="width:100%;padding:12px 14px;border-radius:18px;border:1px solid rgba(47,79,79,0.18);background:rgba(255,255,255,0.9);font-size:0.95rem;font-family:var(--font-ja);outline:none;transition:border-color 0.2s;"
                  />
                </div>
                
                <div class="form-group" style="margin-top:16px;">
                  <label for="reservationPhone" style="display:block;margin-bottom:6px;font-weight:700;color:var(--color-earth);font-size:0.95rem;">電話番号 <span style="color:rgba(47,79,79,0.5);font-size:0.85rem;">（任意）</span></label>
                  <input 
                    type="tel" 
                    id="reservationPhone" 
                    name="phone" 
                    placeholder="090-1234-5678"
                    style="width:100%;padding:12px 14px;border-radius:18px;border:1px solid rgba(47,79,79,0.18);background:rgba(255,255,255,0.9);font-size:0.95rem;font-family:var(--font-ja);outline:none;transition:border-color 0.2s;"
                  />
                </div>
              </div>
              
              <button 
                type="submit" 
                class="btn btn-primary" 
                style="margin-top:18px;width:100%;"
              >
                予約する
              </button>
              <div id="priceFormMessage" style="margin-top:12px;display:none;padding:10px 14px;border-radius:12px;font-size:0.9rem;"></div>
            </form>
          </div>

        </div>
      </div>
    </div>

    <!-- FAQ ポップアップ -->
    <div id="faqPopup" class="popup-overlay" aria-hidden="true">
      <div class="popup-content">
        <button class="popup-close" id="closeFaqPopup" aria-label="閉じる">×</button>
        <div class="container">
          <h2>よくある質問</h2>
          <p class="lead">不安はここで消す。</p>

          <div class="faq reveal delay-200">
            <details class="faq-item">
              <summary>いつ届くの？</summary>
              <p>次回入荷（1月末）後、順番にお届けするビィ</p>
            </details>
            <details class="faq-item">
              <summary>のぞいたら何が見えるの？</summary>
              <p>５枚の思い出が浮かび上がってくるビィ</p>
            </details>
            <details class="faq-item">
              <summary>どうやって５枚選ぶの？</summary>
              <p>十字ボタンで選ぶビィ</p>
            </details>
            <details class="faq-item">
              <summary>６枚目を撮るとどうなる？</summary>
              <p>１枚削除するビィ</p>
            </details>
          </div>

          <!-- お問い合わせフォーム -->
          <div class="faq-contact-form reveal delay-200" style="margin-top:32px;">
            <h3 style="font-size:1.2rem;margin-bottom:16px;color:var(--color-forest);">お問い合わせ</h3>
            <form id="faqContactForm">
              <div class="form-group">
                <label for="faqEmail" style="display:block;margin-bottom:6px;font-weight:700;color:var(--color-earth);font-size:0.95rem;">メールアドレス</label>
                <input 
                  type="email" 
                  id="faqEmail" 
                  name="email" 
                  required 
                  placeholder="your.email@example.com"
                  style="width:100%;padding:12px 14px;border-radius:18px;border:1px solid rgba(47,79,79,0.18);background:rgba(255,255,255,0.9);font-size:0.95rem;font-family:var(--font-ja);outline:none;transition:border-color 0.2s;"
                />
              </div>
              <div class="form-group" style="margin-top:16px;">
                <label for="faqMessage" style="display:block;margin-bottom:6px;font-weight:700;color:var(--color-earth);font-size:0.95rem;">お問い合わせ内容</label>
                <textarea 
                  id="faqMessage" 
                  name="message" 
                  required 
                  rows="6"
                  placeholder="お問い合わせ内容をご記入ください"
                  style="width:100%;padding:12px 14px;border-radius:18px;border:1px solid rgba(47,79,79,0.18);background:rgba(255,255,255,0.9);font-size:0.95rem;font-family:var(--font-ja);outline:none;resize:vertical;transition:border-color 0.2s;"
                ></textarea>
              </div>
              <button 
                type="submit" 
                class="btn btn-primary" 
                style="margin-top:18px;width:100%;"
              >
                送信
              </button>
              <div id="faqFormMessage" style="margin-top:12px;display:none;padding:10px 14px;border-radius:12px;font-size:0.9rem;"></div>
            </form>
          </div>

        </div>
      </div>
    </div>

    <!-- 文章（message from the creator）ポップアップ -->
    <div id="messagePopup" class="popup-overlay" aria-hidden="true">
      <div class="popup-content">
        <button class="popup-close" id="closeMessagePopup" aria-label="閉じる">×</button>
        <div class="container">
          <div class="hero-quote">
            <div class="label">message from the creator</div>
            <p class="creator-text" data-text="水溜りに移り込んだ空は、やがて小さくなっていき、消えてゆく。窓の中の小さな夜を、いつまでも閉じ込めてしまいたいと、どれだけ強く願ってみても、そこに永遠はない。あなたが幸せな時に、あなたが苦しい時に、あなたが頑張りたい時に、いつもそばにいるのは、モビー。"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- 画像ポップアップ -->
    <div id="imagePopup" class="popup-overlay" aria-hidden="true">
      <div class="popup-content image-gallery-popup">
        <button class="popup-close" id="closeImagePopup" aria-label="閉じる">×</button>
        <div class="image-gallery-container">
          <div class="image-gallery-viewport" id="imageGalleryViewport">
            <div class="image-gallery-track" id="imageGalleryTrack">
              <div class="image-gallery-slide">
                <img src="img/1.jpg" alt="Mobby 画像 1" class="gallery-image" loading="lazy">
              </div>
              <div class="image-gallery-slide">
                <img src="img/2.jpg" alt="Mobby 画像 2" class="gallery-image" loading="lazy">
              </div>
              <div class="image-gallery-slide">
                <img src="img/3.jpg" alt="Mobby 画像 3" class="gallery-image" loading="lazy">
              </div>
            </div>
          </div>
          <div class="image-gallery-controls">
            <button class="gallery-nav-btn gallery-prev" id="imageGalleryPrev" aria-label="前の画像">‹</button>
            <button class="gallery-nav-btn gallery-next" id="imageGalleryNext" aria-label="次の画像">›</button>
          </div>
          <div class="image-gallery-indicator" id="imageGalleryIndicator">
            <span class="indicator-dot active" data-index="0"></span>
            <span class="indicator-dot" data-index="1"></span>
            <span class="indicator-dot" data-index="2"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- 動画ポップアップ -->
    <div id="videoPopup" class="popup-overlay" aria-hidden="true">
      <div class="popup-content">
        <button class="popup-close" id="closeVideoPopup" aria-label="閉じる">×</button>
        <div class="container">
          <h2>動画</h2>
          <p class="lead">モビィの動画を確認できます。</p>
          <div class="reveal delay-200" style="margin-top:24px;">
            <video id="mobbyVideo" width="100%" controls style="border-radius:18px;background:#000;">
              <source src="CM/first.mp4" type="video/mp4">
              お使いのブラウザは動画再生に対応していません。
            </video>
          </div>
        </div>
      </div>
    </div>

    
    <!-- ポップアップボタン（最下部） -->
    <div class="popup-buttons-bar">
      <div class="container">
        <div class="popup-buttons">
          <button class="btn btn-secondary" id="openMessagePopup">文章</button>
          <button class="btn btn-secondary" id="openColorsPopup">4色</button>
          <button class="btn btn-secondary" id="openPricePopup">値段</button>
          <button class="btn btn-secondary" id="openFaqPopup">FAQ</button>
          <button class="btn btn-secondary" id="openImagePopup">画像</button>
          <button class="btn btn-secondary" id="openVideoPopup">動画</button>
        </div>
      </div>
    </div>
  </div>



  <!-- Matter.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
  <!-- EmailJS -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <script>
/* reveal */
function initScrollObserver(){
  const revealElements = document.querySelectorAll('.reveal');
  const options = { root:null, rootMargin:'0px', threshold:0.15 };
  const observer = new IntersectionObserver((entries, obs) => {
    entries.forEach(entry => {
      if(entry.isIntersecting){
        entry.target.classList.add('active');
        obs.unobserve(entry.target);
      }
    });
  }, options);
  revealElements.forEach(el => observer.observe(el));
}

/* Stripeリンク（色ごと） */
const STRIPE_URLS = {
  regular: { pink:"https://forms.gle/2PWsZu9sZntjCmVs7", purple:"https://forms.gle/2PWsZu9sZntjCmVs7", blue:"https://forms.gle/2PWsZu9sZntjCmVs7", orange:"https://forms.gle/2PWsZu9sZntjCmVs7" },
  student: { pink:"https://forms.gle/2PWsZu9sZntjCmVs7", purple:"https://forms.gle/2PWsZu9sZntjCmVs7", blue:"https://forms.gle/2PWsZu9sZntjCmVs7", orange:"https://forms.gle/2PWsZu9sZntjCmVs7" }
};

/* 色メタ */
const COLOR_META = {
  pink:   { name:"Peach Pink",      img:"mobby_pink.jpg"   },
  purple: { name:"Twilight Violet", img:"mobby_purple.jpg" },
  blue:   { name:"Aqua Sky",        img:"mobby_blue.jpg"   },
  orange: { name:"Sunny Orange",    img:"mobby_orange.jpg" }
};
const ORDER = ["pink","purple","blue","orange"];

let selectedColor = "pink";
let syncing = false;

/* DOM */
const colorCards = document.querySelectorAll('.color-card');
const selectedText1 = document.getElementById('selectedColorText');
const selectedText2 = document.getElementById('selectedColorText2');
const buyRegularBtn = document.getElementById('buyRegular');
const buyStudentBtn = document.getElementById('buyStudent');
const selectedPreviewImg = document.getElementById('selectedPreviewImg');

/* ===== Hero Carousel (3D Rotating Ring) ===== */
const heroCarousel = document.getElementById("heroCarousel");
const heroTrack = document.getElementById("heroTrack");
// const heroDots = document.getElementById("heroDots"); // 削除されたためコメントアウト
const heroCaption = document.getElementById("heroCaption");
const prevBtn = heroCarousel.querySelector(".carousel-btn.prev");
const nextBtn = heroCarousel.querySelector(".carousel-btn.next");

const heroSlides = [...heroTrack.querySelectorAll(".carousel-slide")];
const n = heroSlides.length;
const angle = 360 / n;

let heroIndex = ORDER.indexOf(selectedColor);
let prevHeroIndex = heroIndex; // 前回のインデックスを保持（初期値は現在のインデックス）
let currentRot = -heroIndex * angle;
let displayedRot = currentRot; // 実際にCSS transformに適用されている角度を保持
let ringRadius = 190;

function mod(a, m){ return ((a % m) + m) % m; }
function degToRad(d){ return d * Math.PI / 180; }

// 角度を-360度から0度の範囲に正規化（-360は0に）
function normalizeAngle(deg){
  deg = deg % 360;
  if(deg > 0) deg -= 360;
  // -360を0に、-0を0に統一
  if(deg === -360 || Object.is(deg, -0)) deg = 0;
  return deg;
}

// 最短経路で角度を計算（-180度から180度の範囲で）
function getShortestRotationAngle(fromIndex, toIndex, angleStep, currentAngle){
  const fromAngle = -fromIndex * angleStep;
  const toAngle = -toIndex * angleStep;
  
  // 現在の角度を基準に、目標角度への最短経路を計算
  let diff = toAngle - currentAngle;
  
  // -180度から180度の範囲に調整（最短経路）
  while(diff > 180) diff -= 360;
  while(diff < -180) diff += 360;
  
  return currentAngle + diff;
}

// ホットスポットのハンドラーをグローバルに保存
const hotspotHandlers = new Map();

function renderHeroDots(){
  // 色ボタンは削除されたため、この関数は何もしない
  // heroDots.innerHTML = "";
  // ORDER.forEach((key, i) => {
  //   const b = document.createElement("button");
  //   b.type = "button";
  //   b.className = "carousel-dot" + (i === heroIndex ? " active" : "");
  //   b.setAttribute("aria-label", `${COLOR_META[key].name} を表示`);
  //   b.addEventListener("click", () => setHeroIndex(i, true));
  //   heroDots.appendChild(b);
  // });
}

function layoutRing(){
  const slide = heroSlides[0];
  const w = slide ? slide.getBoundingClientRect().width : 276;
  ringRadius = Math.round((w/2) / Math.tan(Math.PI / n) + (w * 0.25));

  heroSlides.forEach((s, i) => {
    const h = s.getBoundingClientRect().height || w;
    s.style.transform =
      `translate(${-w/2}px, ${-h/2}px) rotateY(${i * angle}deg) translateZ(${ringRadius}px)`;
    
    // ホットスポットとシャッターを追加（まだない場合）
    const illustration = s.querySelector('.hero-illustration');
    if(illustration && !illustration.querySelector('.carousel-eye-hotspot')){
      const hotspot = document.createElement('button');
      hotspot.className = 'carousel-eye-hotspot';
      hotspot.setAttribute('aria-label', '右目をタップして覗く');
      hotspot.type = 'button';
      
      const shutter = document.createElement('div');
      shutter.className = 'carousel-eye-shutter';
      shutter.setAttribute('aria-hidden', 'true');
      
      illustration.appendChild(hotspot);
      illustration.appendChild(shutter);

      // pointerdownで直接処理（clickイベントに頼らない）
      const handleHotspotPointerDown = (e) => {
        e.stopPropagation();
        e.stopImmediatePropagation();
        e.preventDefault();
        
        // シャッターアニメーション
        shutter.classList.remove('play');
        void shutter.offsetWidth;
        shutter.classList.add('play');
        
        // ビューファインダーを開く
        setTimeout(() => {
          if(typeof window.openViewfinder === 'function'){
            window.openViewfinder(shutter);
          } else {
            console.error('[DEBUG] openViewfinderが関数ではありません:', window.openViewfinder);
          }
        }, 180);
      };
      
      // ハンドラーをマップに保存（heroCarouselのpointerdownから呼び出せるように）
      hotspotHandlers.set(hotspot, handleHotspotPointerDown);
      
      // pointerdownで直接処理（capture phaseで先に処理）
      hotspot.addEventListener('pointerdown', handleHotspotPointerDown, true);
      // clickも一応ハンドリング（ブラウザ差異対策）
      hotspot.addEventListener('click', (e) => {
        e.stopPropagation();
        e.stopImmediatePropagation();
        e.preventDefault();
        handleHotspotPointerDown(e);
      }, true);
      
      // タッチイベントも追加（モバイル対応）
      hotspot.addEventListener('touchend', (e) => {
        e.stopPropagation();
        e.stopImmediatePropagation();
        e.preventDefault();
        
        shutter.classList.remove('play');
        void shutter.offsetWidth;
        shutter.classList.add('play');
        
        setTimeout(() => {
          if(typeof window.openViewfinder === 'function'){
            window.openViewfinder(shutter);
          }
        }, 180);
      }, true);
    }
  });

  updateRing(true);
}

function updateRing(skipTransition=false){
  const key = ORDER[heroIndex];

  if(skipTransition) heroTrack.style.transition = "none";
  else heroTrack.style.transition = "transform 0.7s var(--ease-soft)";

  // 目標角度を計算（常に正確な角度を設定）
  const targetRot = -heroIndex * angle;
  
  if(!skipTransition && prevHeroIndex !== heroIndex){
    // インデックスの変化量を計算（最短経路）
    let delta = heroIndex - prevHeroIndex;
    console.log('[DEBUG] updateRing: prevIndex=', prevHeroIndex, 'newIndex=', heroIndex, 'delta=', delta, 'currentRot=', currentRot, 'displayedRot=', displayedRot);
    
    // 最短経路を選択（-2から+2の範囲に調整）
    if(delta > n / 2) {
      delta -= n;
      console.log('[DEBUG] delta調整: +', delta + n, '→', delta);
    }
    if(delta < -n / 2) {
      delta += n;
      console.log('[DEBUG] delta調整: ', delta - n, '→', delta);
    }
    
    console.log('[DEBUG] 回転前 currentRot=', currentRot, 'delta=', delta, 'angle=', angle);
    // 角度を変化量に基づいて更新（正規化せずに直接加算することで、累積的な回転を維持）
    currentRot = currentRot - (delta * angle);
    displayedRot = currentRot;
    console.log('[DEBUG] 回転後 currentRot=', currentRot);
    
    // インデックス変化時は、deltaに基づく計算結果をそのまま使用し、正規化による再計算は行わない
  } else if(skipTransition){
    // 初期化時は直接設定
    currentRot = targetRot;
    displayedRot = targetRot;
    console.log('[DEBUG] 初期化: currentRot=', currentRot);
  } else {
    // インデックスが変わっていない場合のみ、正規化と最短経路の計算を行う
    displayedRot = normalizeAngle(displayedRot);
    let diff = targetRot - displayedRot;
    // -180度から180度の範囲に調整（最短経路）
    while(diff > 180) diff -= 360;
    while(diff < -180) diff += 360;
    
    // 差が小さい場合（1度以内）は正確に目標角度に設定
    if(Math.abs(diff) < 1) {
      currentRot = targetRot;
      displayedRot = targetRot;
    } else {
      currentRot = displayedRot + diff;
      displayedRot = currentRot;
    }
  }
  
  // 前回のインデックスを更新
  prevHeroIndex = heroIndex;
  
  heroTrack.style.transform = `translate(-50%, -50%) rotateY(${currentRot}deg)`;

  heroSlides.forEach((s, i) => {
    const world = i * angle + currentRot;
    const frontness = Math.cos(degToRad(world));
    s.classList.toggle("dim", frontness < 0.4);
    s.style.zIndex = String(Math.round(1000 * (frontness + 1)));
  });

  // heroDotsは削除されたため、更新処理をスキップ
  // if(heroDots.children.length){
  //   [...heroDots.children].forEach((d, i) => d.classList.toggle("active", i === heroIndex));
  // }
  if(heroCaption) heroCaption.textContent = COLOR_META[key].name;

  if(skipTransition){
    requestAnimationFrame(() => { heroTrack.style.transition = "transform 0.7s var(--ease-soft)"; });
  }
}

function setHeroIndex(i, fromUser){
  heroIndex = mod(i, n);
  updateRing(false);

  if(fromUser){
    syncing = true;
    setSelectedColor(ORDER[heroIndex]);
    syncing = false;
  }
}

function setHeroByColor(colorKey){
  const idx = ORDER.indexOf(colorKey);
  if(idx < 0) return;
  // prevHeroIndexを現在の値に更新してからインデックスを変更
  prevHeroIndex = heroIndex;
  heroIndex = idx;
  updateRing(false);
}

prevBtn.addEventListener("click", () => setHeroIndex(heroIndex - 1, true));
nextBtn.addEventListener("click", () => setHeroIndex(heroIndex + 1, true));
heroSlides.forEach((slide, i) => {
  slide.addEventListener("click", (e) => {
    // ホットスポットやボタンのクリックは無視
    const clickedHotspot = e.target.closest('.carousel-eye-hotspot');
    const clickedBtn = e.target.closest('.carousel-btn');
    if(clickedHotspot || clickedBtn) {
      console.log('[DEBUG] スライドクリック: ホットスポットまたはボタンがクリックされたため無視');
      return;
    }
    
    // クリック位置からホットスポットを検出（3D変換の影響を考慮）
    const allHotspots = slide.querySelectorAll('.carousel-eye-hotspot');
    let isHotspotClick = false;
    
    for(const hotspot of allHotspots) {
      const rect = hotspot.getBoundingClientRect();
      const x = e.clientX;
      const y = e.clientY;
      
      // ホットスポットの領域内かチェック
      if(x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
        // 円形の領域をチェック
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const radius = Math.max(rect.width, rect.height) / 2;
        const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
        
        if(distance <= radius) {
          isHotspotClick = true;
          console.log('[DEBUG] スライドクリック: ホットスポット領域内のため無視');
          break;
        }
      }
    }
    
    if(isHotspotClick) {
      return;
    }
    
    // スライドをクリックしたらcolorポップアップを開く
    console.log('[DEBUG] スライドクリック: colorポップアップを開きます');
    openPopup('colorsPopup');
  });
});

let startX = 0, startRot = 0, dragging = false, isDragged = false;
let activePointerId = null;
let rafId = null; // requestAnimationFrameのID

// ドラッグを終了する関数
function endDrag(e) {
  if(!dragging) return;
  
  // RAFをキャンセル
  if(rafId) {
    cancelAnimationFrame(rafId);
    rafId = null;
  }
  
  dragging = false;
  activePointerId = null;

  if(isDragged){
    // スナップ計算前に角度を正規化（-360〜0度の範囲に収める）
    const normalizedCurrentRot = normalizeAngle(currentRot);
    const normalizedDisplayedRot = normalizeAngle(displayedRot);
    
    // 正規化された角度からスナップ先を計算
    const snapped = mod(Math.round((-normalizedCurrentRot) / angle), n);
    
    // スナップ先の正確な角度を計算
    const targetRot = -snapped * angle;
    const normalizedTargetRot = normalizeAngle(targetRot);
    
    // 正規化されたdisplayedRotから正規化されたtargetRotへの最短経路を計算
    let diff = normalizedTargetRot - normalizedDisplayedRot;
    while(diff > 180) diff -= 360;
    while(diff < -180) diff += 360;
    
    // displayedRotを基準に最短経路で更新
    // これにより、正規化時に逆向きの回転が発生しない
    currentRot = normalizedDisplayedRot + diff;
    displayedRot = currentRot;
    
    // インデックスを設定
    prevHeroIndex = heroIndex;
    heroIndex = snapped;
    
    // トランジションを有効にして、正確な角度にスナップ
    heroTrack.style.transition = "transform 0.7s var(--ease-soft)";
    heroTrack.style.transform = `translate(-50%, -50%) rotateY(${currentRot}deg)`;
    
    // スライドの状態を更新
    heroSlides.forEach((s, i) => {
      const world = i * angle + currentRot;
      const frontness = Math.cos(degToRad(world));
      s.classList.toggle("dim", frontness < 0.4);
      s.style.zIndex = String(Math.round(1000 * (frontness + 1)));
    });
    
    // キャプションを更新
    const key = ORDER[heroIndex];
    if(heroCaption) heroCaption.textContent = COLOR_META[key].name;
    
    // 色の同期
    syncing = true;
    setSelectedColor(key);
    syncing = false;
  } else {
    // ドラッグしていない場合はトランジションを復元
    heroTrack.style.transition = "transform 0.7s var(--ease-soft)";
  }
  
  isDragged = false;
  
  // キャプチャを確実に解放
  if(heroCarousel.releasePointerCapture && e && e.pointerId !== undefined) {
    try {
      heroCarousel.releasePointerCapture(e.pointerId);
    } catch(err) {
      console.warn('Pointer release failed:', err);
    }
  }
}

heroCarousel.addEventListener("pointerdown", (e) => {
  console.log('[DEBUG] heroCarousel pointerdown:', e.target, e.clientX, e.clientY);
  
  // 既存のドラッグ中なら無視
  if(dragging) return;
  
  // クリック位置からホットスポットを検出（3D変換の影響を回避）
  const allHotspots = heroCarousel.querySelectorAll('.carousel-eye-hotspot');
  let clickedHotspot = null;
  
  for(const hotspot of allHotspots) {
    const rect = hotspot.getBoundingClientRect();
    const x = e.clientX;
    const y = e.clientY;
    
    // ホットスポットの領域内かチェック
    if(x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
      // 円形の領域をチェック
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      const radius = Math.max(rect.width, rect.height) / 2;
      const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
      
      if(distance <= radius) {
        clickedHotspot = hotspot;
        console.log('[DEBUG] ホットスポットが検出されました:', hotspot, 'distance:', distance.toFixed(1), 'radius:', radius.toFixed(1));
        break;
      }
    }
  }
  
  if(clickedHotspot) {
    console.log('[DEBUG] heroCarousel pointerdown: ホットスポットがクリックされました', clickedHotspot);
    e.stopPropagation();
    e.preventDefault();
    
    // ホットスポットのハンドラーを直接呼び出す
    const handler = hotspotHandlers.get(clickedHotspot);
    if(handler) {
      handler(e);
    } else {
      console.warn('[DEBUG] ホットスポットのハンドラーが見つかりません');
    }
    return;
  }
  
  // ボタンのクリックは無視
  const isBtn = e.target.closest('.carousel-btn');
  if(isBtn) {
    console.log('[DEBUG] pointerdown: ボタンがクリックされたため無視');
    return;
  }
  
  e.preventDefault(); // デフォルト動作を確実に防止
  dragging = true;
  activePointerId = e.pointerId;
  startX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
  // ドラッグ開始時の角度を正規化して保存
  startRot = normalizeAngle(currentRot);
  isDragged = false;
  heroTrack.style.transition = "none";
  
  // キャプチャを確実に設定
  if(heroCarousel.setPointerCapture) {
    try {
      heroCarousel.setPointerCapture(e.pointerId);
    } catch(err) {
      console.warn('Pointer capture failed:', err);
    }
  }
});

// pointermoveはグローバルにリスニング（pointer captureが失敗した場合のフォールバック）
function handlePointerMove(e) {
  if(!dragging) return;
  // アクティブなポインターIDと一致するか確認
  if(activePointerId !== null && e.pointerId !== activePointerId) return;
  
  // RAF内で処理をバッチ化
  if(rafId) return; // 既にRAFが予約されていたらスキップ
  
  rafId = requestAnimationFrame(() => {
    rafId = null;
    
    const currentX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : startX);
    const dx = currentX - startX;
    
    if(Math.abs(dx) > 3) isDragged = true;
    
    const rot = startRot + dx * 0.2;
    // ドラッグ中は角度をそのまま使用（スナップ時に正規化）
    currentRot = rot;
    displayedRot = rot;
    
    heroTrack.style.transform = `translate(-50%, -50%) rotateY(${rot}deg)`;
    
    // スライドの更新も同じRAF内で
    heroSlides.forEach((s, i) => {
      const world = i * angle + rot;
      const frontness = Math.cos(degToRad(world));
      s.classList.toggle("dim", frontness < 0.4);
      s.style.zIndex = String(Math.round(1000 * (frontness + 1)));
    });
  });
  
  e.preventDefault();
}

heroCarousel.addEventListener("pointermove", handlePointerMove);
// グローバルにもリスニング（pointer captureが失敗した場合のフォールバック）
document.addEventListener("pointermove", handlePointerMove);

// pointerupもグローバルにリスニング
function handlePointerUp(e) {
  if(!dragging) return;
  // アクティブなポインターIDと一致するか確認
  if(activePointerId !== null && e.pointerId !== activePointerId) return;
  endDrag(e);
}

heroCarousel.addEventListener("pointerup", handlePointerUp);
document.addEventListener("pointerup", handlePointerUp);

// pointercancelイベント（タッチが中断された場合）
function handlePointerCancel(e) {
  if(!dragging) return;
  if(activePointerId !== null && e.pointerId !== activePointerId) return;
  endDrag(e);
}

heroCarousel.addEventListener("pointercancel", handlePointerCancel);
document.addEventListener("pointercancel", handlePointerCancel);

// ポインターが失われた場合の処理
heroCarousel.addEventListener("lostpointercapture", endDrag);

// ビューポート外に出た場合の処理
document.addEventListener("pointerup", (e) => {
  if(dragging && e.pointerId === activePointerId) {
    endDrag(e);
  }
});

/* 初期化 */
renderHeroDots();
// layoutRing()はビューファインダー初期化後に呼ぶ（ホットスポットのクリックイベント設定のため）
// 初期レイアウトは後で実行

// デバウンス付きリサイズ処理
let resizeTimer = null;
window.addEventListener("resize", () => {
  if(resizeTimer) clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    layoutRing();
    updateRing(true);
  }, 150); // 150msのデバウンス
}, { passive:true });

/* 選択色の反映 */
function setSelectedColor(key){
  if(!COLOR_META[key]) return;
  selectedColor = key;

  colorCards.forEach(card => {
    card.classList.toggle('selected', card.dataset.color === key);
  });

  const meta = COLOR_META[key];
  if(selectedText1) selectedText1.textContent = meta.name;
  if(selectedText2) selectedText2.textContent = meta.name;

  if(selectedPreviewImg){
    selectedPreviewImg.src = meta.img;
    selectedPreviewImg.alt = `Mobby ${meta.name}`;
  }

  if(!syncing) setHeroByColor(key);
}

function goBuy(url){
  if(!url || url.trim().length === 0){
    alert('Stripeの購入リンク（STRIPE_URLS）をコードに入れてください。');
    return;
  }
  window.open(url, '_blank', 'noopener,noreferrer');
}

buyRegularBtn && buyRegularBtn.addEventListener('click', (e) => {
  e.preventDefault();
  goBuy(STRIPE_URLS.regular[selectedColor]);
});

buyStudentBtn && buyStudentBtn.addEventListener('click', (e) => {
  e.preventDefault();
  goBuy(STRIPE_URLS.student[selectedColor] || STRIPE_URLS.regular[selectedColor]);
});

colorCards.forEach(card => {
  card.addEventListener('click', () => setSelectedColor(card.dataset.color));
  card.addEventListener('keydown', (e) => {
    if(e.key === 'Enter' || e.key === ' '){
      e.preventDefault();
      setSelectedColor(card.dataset.color);
    }
  });
});

/* 初期描画 */
// 初期化時にprevHeroIndexを確実に設定
prevHeroIndex = heroIndex;
setHeroByColor(selectedColor);
syncing = true;
setSelectedColor(selectedColor);
syncing = false;

/* smooth scroll */
document.addEventListener('click', (e) => {
  const a = e.target.closest('a[href^="#"]');
  if(!a) return;
  const id = a.getAttribute('href');
  if(id.length <= 1) return;
  const el = document.querySelector(id);
  if(!el) return;
  e.preventDefault();
  el.scrollIntoView({ behavior:'smooth', block:'start' });
});

/* Splash (Matter.js) */
const ICON_URLS   = ['icon1.png','icon2.png','icon3.png','icon4.png'];
// スマホの時は半分のサイズにする
const ICON_SIZE   = window.innerWidth <= 768 ? 75 : 150;
const SPAWN_RATE  = 100;
const TOTAL_ICONS = 50;

const Engine    = Matter.Engine;
const Render    = Matter.Render;
const Runner    = Matter.Runner;
const Bodies    = Matter.Bodies;
const Composite = Matter.Composite;
const Body      = Matter.Body;

const splashElement = document.getElementById('splash-screen');
const mainContent   = document.getElementById('main-content');

const engine = Engine.create();
const world  = engine.world;

let width  = window.innerWidth;
let height = window.innerHeight;

const render = Render.create({
  element: splashElement,
  engine: engine,
  options: { width, height, background: 'transparent', wireframes: false }
});

const wallOptions = { isStatic:true, render:{ visible:false } };
const floor = Bodies.rectangle(width/2, height+50, width+200, 100, wallOptions);
const leftWall = Bodies.rectangle(-60, height/2, 120, height+200, wallOptions);
const rightWall = Bodies.rectangle(width+60, height/2, 120, height+200, wallOptions);
Composite.add(world, [floor, leftWall, rightWall]);

function preloadImages(urls){
  const tasks = urls.map(url => new Promise(resolve => {
    const img = new Image();
    img.onload  = () => resolve({ url, ok:true });
    img.onerror = () => resolve({ url, ok:false });
    img.src = url;
  }));
  return Promise.all(tasks);
}

let AVAILABLE_ICON_URLS = [];
let count = 0;
let dropTimer = null;

function startDropping(){
  dropTimer = setInterval(() => {
    if(count >= TOTAL_ICONS){ clearInterval(dropTimer); return; }

    const xPos = Math.random() * (width - 120) + 60;
    const hasSprite = AVAILABLE_ICON_URLS.length > 0;
    const texture = hasSprite ? AVAILABLE_ICON_URLS[Math.floor(Math.random()*AVAILABLE_ICON_URLS.length)] : null;

    const opts = { restitution:0.55, friction:0.08, frictionAir:0.03, render:{} };

    if(hasSprite){
      opts.render.sprite = { texture, xScale: ICON_SIZE/512, yScale: ICON_SIZE/512 };
    }else{
      const fallbackColors = ['#8FD7FF', '#F7A7C6', '#FFA24A', '#9C7BFF'];
      opts.render.fillStyle = fallbackColors[Math.floor(Math.random()*fallbackColors.length)];
      opts.render.strokeStyle = 'rgba(255,255,255,0.35)';
      opts.render.lineWidth = 2;
    }

    const icon = Bodies.circle(xPos, -60, ICON_SIZE/2, opts);
    Composite.add(world, icon);
    count++;
  }, SPAWN_RATE);
}

Render.run(render);
const runner = Runner.create();
Runner.run(runner, engine);

preloadImages(ICON_URLS).then(results => {
  AVAILABLE_ICON_URLS = results.filter(r => r.ok).map(r => r.url);
  startDropping();
});

splashElement && splashElement.addEventListener('click', () => {
  if(dropTimer) clearInterval(dropTimer);

  const bodies = Composite.allBodies(world);
  bodies.forEach(body => {
    if(!body.isStatic){
      const force = 0.5 * body.mass;
      Body.applyForce(body, body.position, {
        x:(Math.random()-0.5)*force,
        y:(Math.random()-1.5)*force
      });
    }
  });

  setTimeout(() => {
    splashElement.classList.add('hidden');
    mainContent.classList.add('visible');
    document.body.style.overflowY = 'auto';
    initScrollObserver();
    if(stickyCta) stickyCta.style.display = 'block';

    setTimeout(() => {
      Render.stop(render);
      Runner.stop(runner);
      engine.enabled = false;
      splashElement.remove();
    }, 1200);
  }, 500);
});

window.addEventListener('resize', () => {
  width  = window.innerWidth;
  height = window.innerHeight;

  render.canvas.width = width;
  render.canvas.height = height;
  render.options.width = width;
  render.options.height = height;

  Body.setPosition(floor, { x: width/2, y: height+50 });
  Body.setPosition(leftWall, { x: -60, y: height/2 });
  Body.setPosition(rightWall, { x: width+60, y: height/2 });
  
  // 画像ギャラリーが開いている場合は更新
  const imagePopup = document.getElementById('imagePopup');
  if(imagePopup && imagePopup.classList.contains('is-open')){
    updateImageGallery();
  }
}, { passive:true });

/* ===== Retro Camera Demo (Overlay) ===== */
// ビューファインダーを開く関数をグローバルに公開（先に定義）
window.openViewfinder = null;

(() => {
  const overlay  = document.getElementById('vfOverlay');
  const closeBtn = document.getElementById('vfClose');
  const backdrop = document.getElementById('vfBackdrop');

  const viewfinder = document.getElementById('rcViewfinder');
  const container  = document.getElementById('rcPhotoContainer');
  const snapBtn    = document.getElementById('rcSnap');
  const counterEl  = document.getElementById('vfCounter');

  if(!overlay || !closeBtn || !backdrop || !viewfinder || !container || !snapBtn || !counterEl) return;

  // スクロール復元
  let prevBodyOverflow = '';
  let prevBodyOverflowY = '';
  let prevHtmlOverflow = '';

  // 初期5枚（ローカル画像で安定運用）
  const SEED = [
    "mobby_pink.jpg",
    "mobby_purple.jpg",
    "mobby_blue.jpg",
    "mobby_orange.jpg",
    "mobby_pink.jpg"
  ];
  let photos = SEED.map((url, i) => ({ id: i + 1, url }));

  let dustMade = false;

  function updateCounter(){
    counterEl.textContent = `${photos.length} / 5`;
  }

  function renderPhotos(){
    const existing = Array.from(container.children);

    photos.forEach((photo, index) => {
      let el = document.getElementById(`rc-p-${photo.id}`);

      if(!el){
        el = document.createElement('div');
        el.id = `rc-p-${photo.id}`;
        el.className = 'rc-polaroid rc-age-0';
        el.style.opacity = '0';

        const img = document.createElement('img');
        img.src = photo.url;
        img.alt = `photo ${index + 1}`;
        img.draggable = false;

        el.appendChild(img);
        container.appendChild(el);

        setTimeout(() => { el.style.opacity = '1'; }, 50);
      }

      el.classList.remove('rc-age-0','rc-age-1','rc-age-2','rc-age-3','rc-age-4');
      el.classList.add(`rc-age-${index}`);
    });

    const currentIds = photos.map(p => `rc-p-${p.id}`);
    existing.forEach(el => {
      if(!currentIds.includes(el.id)){
        el.style.opacity = '0';
        el.style.transform = 'scale(0.5)';
        setTimeout(() => el.remove(), 800);
      }
    });

    updateCounter();
  }

  // “エモ”フラッシュ（やわらかい光漏れ）
  function addFlashEffect(){
    const flash = document.createElement('div');
    flash.style.position = 'absolute';
    flash.style.inset = '0';
    flash.style.background =
      'radial-gradient(circle at center, #fff 0%, rgba(255,255,255,0.8) 30%, rgba(255,255,255,0) 65%)';
    flash.style.opacity = '0.92';
    flash.style.zIndex = '200';
    flash.style.pointerEvents = 'none';
    flash.style.transition = 'opacity 0.25s ease-out';

    viewfinder.appendChild(flash);

    requestAnimationFrame(() => {
      requestAnimationFrame(() => { flash.style.opacity = '0'; });
    });

    setTimeout(() => flash.remove(), 350);
  }

  function createDust(){
    if(dustMade) return;
    dustMade = true;
    for(let i=0;i<40;i++){
      const d = document.createElement('div');
      d.className = 'rc-dust';
      d.style.left = `${Math.random()*100}%`;
      d.style.top  = `${Math.random()*100}%`;
      const size = Math.random() * 2;
      d.style.width = `${size}px`;
      d.style.height = `${size}px`;
      d.style.opacity = String(Math.random() * 0.5);
      viewfinder.appendChild(d);
    }
  }

// ▼ 追加：デモ用の画像プール（毎回ここから回す）
const DEMO_POOL = [
  "mobby_pink.jpg",
  "mobby_purple.jpg",
  "mobby_blue.jpg",
  "mobby_orange.jpg",
];
let demoCursor = 0;

// ▼ 置き換え：takePhoto()
function takePhoto(){
  const newId = Date.now();

  // 毎回違う画像になるようにローテーション
  const baseUrl = DEMO_POOL[demoCursor % DEMO_POOL.length];
  demoCursor++;

  // 同じファイルでもブラウザキャッシュで見た目が変わらない事故を防ぐ（保険）
  const url = `${baseUrl}?cb=${newId}`;

  photos.unshift({ id: newId, url });
  if(photos.length > 5) photos.pop();

  renderPhotos();
  addFlashEffect();
}


  function open(){
    overlay.classList.add('is-open');
    overlay.setAttribute('aria-hidden', 'false');

    prevBodyOverflow  = document.body.style.overflow;
    prevBodyOverflowY = document.body.style.overflowY;
    prevHtmlOverflow  = document.documentElement.style.overflow;

    document.body.style.overflow = 'hidden';
    document.body.style.overflowY = 'hidden';
    document.documentElement.style.overflow = 'hidden';

    createDust();
    renderPhotos();
  }

  function close(){
    overlay.classList.remove('is-open');
    overlay.setAttribute('aria-hidden', 'true');

    document.body.style.overflow  = prevBodyOverflow;
    document.body.style.overflowY = prevBodyOverflowY;
    document.documentElement.style.overflow = prevHtmlOverflow;
  }

  // ビューファインダーを開く関数をグローバルに公開
  window.openViewfinder = function(shutterElement = null){
    console.log('[DEBUG] openViewfinderが呼ばれました, shutterElement:', shutterElement);
    // シャッターアニメーション（指定された要素またはデフォルトのeyeShutter）
    const shutter = shutterElement || eyeShutter;
    console.log('[DEBUG] 使用するshutter:', shutter);
    if(shutter){
      shutter.classList.remove('play');
      void shutter.offsetWidth;
      shutter.classList.add('play');
      console.log('[DEBUG] シャッターアニメーション実行');
    } else {
      console.warn('[DEBUG] shutter要素が見つかりません');
    }
    setTimeout(() => {
      console.log('[DEBUG] open関数を呼び出します');
      open();
    }, 180);
  };
  console.log('[DEBUG] window.openViewfinderが定義されました:', typeof window.openViewfinder);


  // snap / close
  snapBtn.addEventListener('click', takePhoto);
  closeBtn.addEventListener('click', close);
  backdrop.addEventListener('click', close);
  window.addEventListener('keydown', (e) => {
    if(!overlay.classList.contains('is-open')) return;
    if(e.key === 'Escape') close();
  });
})();

// ビューファインダー初期化後にカルーセルのレイアウトを実行（ホットスポットのクリックイベント設定のため）
console.log('[DEBUG] layoutRingを実行します, openViewfinder:', typeof window.openViewfinder);
layoutRing();
console.log('[DEBUG] layoutRing実行完了');

/* ===== ポップアップ制御 ===== */
let typingInterval = null;

function startTypingAnimation(element){
  if(!element) return;
  const fullText = element.getAttribute('data-text') || element.textContent.trim();
  if(!fullText) return;
  
  // 既存のタイピングを停止
  if(typingInterval){
    clearInterval(typingInterval);
    typingInterval = null;
  }
  
  // テキストを空にして、クラスをリセット
  element.textContent = '';
  element.classList.remove('typing-complete');
  
  let currentIndex = 0;
  const typingSpeed = 50; // ミリ秒（日本語なので少し遅め）
  
  typingInterval = setInterval(() => {
    if(currentIndex < fullText.length){
      element.textContent = fullText.substring(0, currentIndex + 1);
      currentIndex++;
    } else {
      clearInterval(typingInterval);
      typingInterval = null;
      element.classList.add('typing-complete');
    }
  }, typingSpeed);
}

function openPopup(popupId){
  const popup = document.getElementById(popupId);
  if(!popup) return;
  popup.classList.add('is-open');
  popup.setAttribute('aria-hidden', 'false');
  document.body.style.overflow = 'hidden';
  
  // messagePopupの場合、タイピングアニメーションを開始
  if(popupId === 'messagePopup'){
    const creatorText = popup.querySelector('.creator-text');
    if(creatorText){
      // ポップアップが開いてから少し遅延させてタイピング開始
      setTimeout(() => {
        startTypingAnimation(creatorText);
      }, 300);
    }
  }
  
  // videoPopupの場合、動画を自動再生
  if(popupId === 'videoPopup'){
    const video = popup.querySelector('#mobbyVideo');
    if(video){
      // ポップアップが開いてから少し遅延させて再生開始
      setTimeout(() => {
        video.currentTime = 0; // 最初から再生
        video.play().catch(err => {
          console.log('動画の自動再生に失敗しました:', err);
        });
      }, 300);
    }
  }
  
  // imagePopupの場合、ギャラリーを初期化
  if(popupId === 'imagePopup'){
    setTimeout(() => {
      initImageGallery();
    }, 100);
  }
}

function closePopup(popupId){
  const popup = document.getElementById(popupId);
  if(!popup) return;
  
  // タイピングアニメーションを停止
  if(typingInterval){
    clearInterval(typingInterval);
    typingInterval = null;
  }
  
  popup.classList.remove('is-open');
  popup.setAttribute('aria-hidden', 'true');
  document.body.style.overflow = '';
  
  // messagePopupの場合、テキストをリセット
  if(popupId === 'messagePopup'){
    const creatorText = popup.querySelector('.creator-text');
    if(creatorText){
      creatorText.textContent = '';
      creatorText.classList.remove('typing-complete');
    }
  }
  
  // videoPopupの場合、動画を停止してリセット
  if(popupId === 'videoPopup'){
    const video = popup.querySelector('#mobbyVideo');
    if(video){
      video.pause();
      video.currentTime = 0;
    }
  }
}

/* ===== Image Gallery (Apple-style) ===== */
let imageGalleryIndex = 0;
let imageGalleryTranslateX = 0;
let imageGalleryIsDragging = false;
let imageGalleryStartX = 0;
let imageGalleryStartTranslateX = 0; // pointerdown時の初期translateXを保存
let imageGalleryStartTime = 0;
let imageGalleryVelocity = 0;
let imageGalleryLastX = 0;
let imageGalleryLastTime = 0;
let imageGalleryTotalSlides = 0;

function initImageGallery(){
  const track = document.getElementById('imageGalleryTrack');
  const viewport = document.getElementById('imageGalleryViewport');
  const prevBtn = document.getElementById('imageGalleryPrev');
  const nextBtn = document.getElementById('imageGalleryNext');
  const indicators = document.querySelectorAll('.indicator-dot');
  const slides = document.querySelectorAll('.image-gallery-slide');
  
  if(!track || !viewport) return;
  
  imageGalleryTotalSlides = slides.length;
  
  // インデックスをリセット
  imageGalleryIndex = 0;
  imageGalleryTranslateX = 0;
  updateImageGallery();
  
  // 前へボタン
  if(prevBtn){
    prevBtn.addEventListener('click', () => {
      if(imageGalleryIndex > 0){
        imageGalleryIndex--;
        updateImageGallery();
      }
    });
  }
  
  // 次へボタン
  if(nextBtn){
    nextBtn.addEventListener('click', () => {
      if(imageGalleryIndex < imageGalleryTotalSlides - 1){
        imageGalleryIndex++;
        updateImageGallery();
      }
    });
  }
  
  // インジケーター
  indicators.forEach((dot, index) => {
    dot.addEventListener('click', () => {
      imageGalleryIndex = index;
      updateImageGallery();
    });
  });
  
  // スワイプ機能（滑らかな動作）
  viewport.addEventListener('pointerdown', (e) => {
    if(imageGalleryIsDragging) return;
    imageGalleryIsDragging = true;
    imageGalleryStartX = e.clientX;
    imageGalleryStartTime = Date.now();
    imageGalleryLastX = e.clientX;
    imageGalleryLastTime = imageGalleryStartTime;
    imageGalleryVelocity = 0;
    
    const slideWidth = viewport.offsetWidth;
    imageGalleryStartTranslateX = -imageGalleryIndex * slideWidth; // 初期位置を保存
    imageGalleryTranslateX = imageGalleryStartTranslateX;
    
    viewport.style.cursor = 'grabbing';
    track.style.transition = 'none';
    e.preventDefault();
  });
  
  viewport.addEventListener('pointermove', (e) => {
    if(!imageGalleryIsDragging) return;
    
    const currentX = e.clientX;
    const currentTime = Date.now();
    const slideWidth = viewport.offsetWidth;
    const diff = currentX - imageGalleryStartX; // 開始位置からの移動量
    
    // 速度を計算（スムーズなスワイプ判定のため）
    if(currentTime - imageGalleryLastTime > 0){
      imageGalleryVelocity = (currentX - imageGalleryLastX) / (currentTime - imageGalleryLastTime);
      imageGalleryLastX = currentX;
      imageGalleryLastTime = currentTime;
    }
    
    // 境界チェック（最初と最後のスライドで越えないように）
    // 初期位置に移動量を加算
    const targetTranslate = imageGalleryStartTranslateX + diff;
    const minTranslate = -(imageGalleryTotalSlides - 1) * slideWidth;
    const maxTranslate = 0;
    
    // 境界を超えた場合の抵抗効果
    if(targetTranslate > maxTranslate){
      imageGalleryTranslateX = maxTranslate + (targetTranslate - maxTranslate) * 0.3;
    } else if(targetTranslate < minTranslate){
      imageGalleryTranslateX = minTranslate + (targetTranslate - minTranslate) * 0.3;
    } else {
      imageGalleryTranslateX = targetTranslate;
    }
    
    track.style.transform = `translateX(${imageGalleryTranslateX}px)`;
    e.preventDefault();
  });
  
  viewport.addEventListener('pointerup', (e) => {
    if(!imageGalleryIsDragging) return;
    imageGalleryIsDragging = false;
    viewport.style.cursor = 'grab';
    
    const slideWidth = viewport.offsetWidth;
    const initialTranslateX = -imageGalleryIndex * slideWidth; // 開始時の位置
    const diff = imageGalleryTranslateX - initialTranslateX; // 実際の移動距離
    const threshold = slideWidth * 0.01; // 1%の閾値（少しのスワイプで反応）
    const speedThreshold = 0.01; // 速度の閾値（px/ms）- より敏感に
    
    // 速度ベースの判定（高速スワイプ時）- 優先度を上げる
    if(Math.abs(imageGalleryVelocity) > speedThreshold){
      if(imageGalleryVelocity < 0 && imageGalleryIndex < imageGalleryTotalSlides - 1){
        imageGalleryIndex++;
      } else if(imageGalleryVelocity > 0 && imageGalleryIndex > 0){
        imageGalleryIndex--;
      }
    } 
    // 距離ベースの判定（低速スワイプ時）
    else if(Math.abs(diff) > threshold){
      if(diff < 0 && imageGalleryIndex < imageGalleryTotalSlides - 1){
        imageGalleryIndex++;
      } else if(diff > 0 && imageGalleryIndex > 0){
        imageGalleryIndex--;
      }
    }
    
    updateImageGallery();
  });
  
  viewport.addEventListener('pointercancel', () => {
    if(!imageGalleryIsDragging) return;
    imageGalleryIsDragging = false;
    viewport.style.cursor = 'grab';
    updateImageGallery();
  });
  
  // キーボードナビゲーション
  const handleKeyDown = (e) => {
    if(e.key === 'ArrowLeft' && imageGalleryIndex > 0){
      imageGalleryIndex--;
      updateImageGallery();
      e.preventDefault();
    } else if(e.key === 'ArrowRight' && imageGalleryIndex < imageGalleryTotalSlides - 1){
      imageGalleryIndex++;
      updateImageGallery();
      e.preventDefault();
    }
  };
  
  viewport.addEventListener('keydown', handleKeyDown);
  // ポップアップが開いている時はdocumentでもキーイベントをリッスン
  document.addEventListener('keydown', handleKeyDown);
}

function updateImageGallery(){
  const viewport = document.getElementById('imageGalleryViewport');
  const track = document.getElementById('imageGalleryTrack');
  const indicators = document.querySelectorAll('.indicator-dot');
  const prevBtn = document.getElementById('imageGalleryPrev');
  const nextBtn = document.getElementById('imageGalleryNext');
  
  if(!viewport || !track) return;
  
  const slideWidth = viewport.offsetWidth;
  imageGalleryTranslateX = -imageGalleryIndex * slideWidth;
  
  // トランジションを有効にして滑らかに移動
  if(!imageGalleryIsDragging){
    track.style.transition = 'transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
  }
  track.style.transform = `translateX(${imageGalleryTranslateX}px)`;
  
  // インジケーターを更新
  indicators.forEach((dot, index) => {
    dot.classList.toggle('active', index === imageGalleryIndex);
  });
  
  // ボタンの有効/無効を更新
  if(prevBtn){
    prevBtn.style.opacity = imageGalleryIndex === 0 ? '0.5' : '1';
    prevBtn.style.pointerEvents = imageGalleryIndex === 0 ? 'none' : 'auto';
  }
  if(nextBtn){
    nextBtn.style.opacity = imageGalleryIndex === imageGalleryTotalSlides - 1 ? '0.5' : '1';
    nextBtn.style.pointerEvents = imageGalleryIndex === imageGalleryTotalSlides - 1 ? 'none' : 'auto';
  }
}

// ポップアップボタンのイベント
document.getElementById('openMessagePopup')?.addEventListener('click', () => openPopup('messagePopup'));
document.getElementById('openColorsPopup')?.addEventListener('click', () => openPopup('colorsPopup'));
document.getElementById('openPricePopup')?.addEventListener('click', () => openPopup('pricePopup'));
document.getElementById('openFaqPopup')?.addEventListener('click', () => openPopup('faqPopup'));
document.getElementById('openImagePopup')?.addEventListener('click', () => openPopup('imagePopup'));
document.getElementById('openVideoPopup')?.addEventListener('click', () => openPopup('videoPopup'));

// 閉じるボタンのイベント
document.getElementById('closeMessagePopup')?.addEventListener('click', () => closePopup('messagePopup'));
document.getElementById('closeColorsPopup')?.addEventListener('click', () => closePopup('colorsPopup'));
document.getElementById('closePricePopup')?.addEventListener('click', () => closePopup('pricePopup'));
document.getElementById('closeFaqPopup')?.addEventListener('click', () => closePopup('faqPopup'));
document.getElementById('closeImagePopup')?.addEventListener('click', () => closePopup('imagePopup'));
document.getElementById('closeVideoPopup')?.addEventListener('click', () => closePopup('videoPopup'));

// オーバーレイクリックで閉じる
document.getElementById('messagePopup')?.addEventListener('click', (e) => {
  if(e.target.id === 'messagePopup') closePopup('messagePopup');
});
document.getElementById('colorsPopup')?.addEventListener('click', (e) => {
  if(e.target.id === 'colorsPopup') closePopup('colorsPopup');
});
document.getElementById('pricePopup')?.addEventListener('click', (e) => {
  if(e.target.id === 'pricePopup') closePopup('pricePopup');
});
document.getElementById('faqPopup')?.addEventListener('click', (e) => {
  if(e.target.id === 'faqPopup') closePopup('faqPopup');
});
document.getElementById('imagePopup')?.addEventListener('click', (e) => {
  // ギャラリーコンテナ内のクリックは無視
  if(e.target.closest('.image-gallery-container')) return;
  if(e.target.id === 'imagePopup') closePopup('imagePopup');
});
document.getElementById('videoPopup')?.addEventListener('click', (e) => {
  if(e.target.id === 'videoPopup') closePopup('videoPopup');
});

// ESCキーで閉じる
window.addEventListener('keydown', (e) => {
  if(e.key === 'Escape'){
    if(document.getElementById('messagePopup')?.classList.contains('is-open')) closePopup('messagePopup');
    if(document.getElementById('colorsPopup')?.classList.contains('is-open')) closePopup('colorsPopup');
    if(document.getElementById('pricePopup')?.classList.contains('is-open')) closePopup('pricePopup');
    if(document.getElementById('faqPopup')?.classList.contains('is-open')) closePopup('faqPopup');
    if(document.getElementById('imagePopup')?.classList.contains('is-open')) closePopup('imagePopup');
    if(document.getElementById('videoPopup')?.classList.contains('is-open')) closePopup('videoPopup');
  }
});

// ポップアップ間の遷移
document.getElementById('openPriceFromColors')?.addEventListener('click', () => {
  closePopup('colorsPopup');
  setTimeout(() => openPopup('pricePopup'), 200);
});
document.getElementById('openColorsFromFaq')?.addEventListener('click', () => {
  closePopup('faqPopup');
  setTimeout(() => openPopup('colorsPopup'), 200);
});

// EmailJS初期化（実際の使用時はPublic Keyを設定する必要があります）
// 注意: 本番環境では、EmailJSの設定（Service ID、Template ID、Public Key）が必要です
// ここではmailto:リンクを使用するフォールバック方式を実装します

// 値段ポップアップの抽選予約フォーム送信
document.getElementById('priceReservationForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const form = e.target;
  const address = document.getElementById('reservationAddress').value;
  const name = document.getElementById('reservationName').value;
  const email = document.getElementById('reservationEmail').value;
  const phone = document.getElementById('reservationPhone').value;
  const messageDiv = document.getElementById('priceFormMessage');
  const submitBtn = form.querySelector('button[type="submit"]');
  
  // バリデーション（住所は必須）
  if(!address || address.trim() === '') {
    messageDiv.style.display = 'block';
    messageDiv.style.background = 'rgba(255,0,0,0.1)';
    messageDiv.style.border = '1px solid rgba(255,0,0,0.3)';
    messageDiv.style.color = 'var(--color-earth)';
    messageDiv.textContent = '住所を入力してください。';
    return;
  }
  
  // 送信ボタンを無効化
  submitBtn.disabled = true;
  submitBtn.textContent = '送信中...';
  messageDiv.style.display = 'none';
  
  try {
    // EmailJSを使用する場合（設定が必要）
    // emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', {
    //   to_email: 'info.mobbymobbymobby@gmail.com',
    //   subject: '購入の抽選予約',
    //   address: address,
    //   name: name,
    //   email: email,
    //   phone: phone
    // }, 'YOUR_PUBLIC_KEY');
    
    // フォールバック: mailto:リンクを使用
    const subject = encodeURIComponent('購入の抽選予約');
    
    // メール本文を作成
    let bodyText = '購入の抽選予約を希望します。\n\n';
    bodyText += '【住所】\n' + address + '\n\n';
    
    if(name && name.trim() !== '') {
      bodyText += '【名前】\n' + name + '\n\n';
    }
    if(email && email.trim() !== '') {
      bodyText += '【メールアドレス】\n' + email + '\n\n';
    }
    if(phone && phone.trim() !== '') {
      bodyText += '【電話番号】\n' + phone + '\n\n';
    }
    
    bodyText += '抽選に当たったら、モビィから当選の手紙が届くことを確認しました。';
    
    const body = encodeURIComponent(bodyText);
    const mailtoLink = `mailto:info.mobbymobbymobby@gmail.com?subject=${subject}&body=${body}`;
    
    // メールクライアントを開く
    window.location.href = mailtoLink;
    
    // 成功メッセージを表示
    messageDiv.style.display = 'block';
    messageDiv.style.background = 'rgba(0,255,0,0.1)';
    messageDiv.style.border = '1px solid rgba(0,255,0,0.3)';
    messageDiv.style.color = 'var(--color-earth)';
    messageDiv.textContent = 'メールクライアントが開きます。メールを送信してください。';
    
    // フォームをリセット
    setTimeout(() => {
      form.reset();
      submitBtn.disabled = false;
      submitBtn.textContent = '予約する';
    }, 2000);
    
  } catch (error) {
    console.error('送信エラー:', error);
    messageDiv.style.display = 'block';
    messageDiv.style.background = 'rgba(255,0,0,0.1)';
    messageDiv.style.border = '1px solid rgba(255,0,0,0.3)';
    messageDiv.style.color = 'var(--color-earth)';
    messageDiv.textContent = '送信に失敗しました。もう一度お試しください。';
    submitBtn.disabled = false;
    submitBtn.textContent = '予約する';
  }
});

// FAQお問い合わせフォーム送信
document.getElementById('faqContactForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const form = e.target;
  const email = document.getElementById('faqEmail').value;
  const message = document.getElementById('faqMessage').value;
  const messageDiv = document.getElementById('faqFormMessage');
  const submitBtn = form.querySelector('button[type="submit"]');
  
  // バリデーション
  if(!email || !message) {
    messageDiv.style.display = 'block';
    messageDiv.style.background = 'rgba(255,0,0,0.1)';
    messageDiv.style.border = '1px solid rgba(255,0,0,0.3)';
    messageDiv.style.color = 'var(--color-earth)';
    messageDiv.textContent = 'メールアドレスとお問い合わせ内容を入力してください。';
    return;
  }
  
  // 送信ボタンを無効化
  submitBtn.disabled = true;
  submitBtn.textContent = '送信中...';
  messageDiv.style.display = 'none';
  
  try {
    // EmailJSを使用する場合（設定が必要）
    // emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', {
    //   to_email: 'info.mobbymobbymobby@gmail.com',
    //   from_email: email,
    //   message: message
    // }, 'YOUR_PUBLIC_KEY');
    
    // フォールバック: mailto:リンクを使用
    const subject = encodeURIComponent('Mobby お問い合わせ');
    const body = encodeURIComponent(`メールアドレス: ${email}\n\nお問い合わせ内容:\n${message}`);
    const mailtoLink = `mailto:info.mobbymobbymobby@gmail.com?subject=${subject}&body=${body}`;
    
    // メールクライアントを開く
    window.location.href = mailtoLink;
    
    // 成功メッセージを表示
    messageDiv.style.display = 'block';
    messageDiv.style.background = 'rgba(0,255,0,0.1)';
    messageDiv.style.border = '1px solid rgba(0,255,0,0.3)';
    messageDiv.style.color = 'var(--color-earth)';
    messageDiv.textContent = 'メールクライアントが開きます。メールを送信してください。';
    
    // フォームをリセット
    setTimeout(() => {
      form.reset();
      submitBtn.disabled = false;
      submitBtn.textContent = '送信';
    }, 2000);
    
  } catch (error) {
    console.error('送信エラー:', error);
    messageDiv.style.display = 'block';
    messageDiv.style.background = 'rgba(255,0,0,0.1)';
    messageDiv.style.border = '1px solid rgba(255,0,0,0.3)';
    messageDiv.style.color = 'var(--color-earth)';
    messageDiv.textContent = '送信に失敗しました。もう一度お試しください。';
    submitBtn.disabled = false;
    submitBtn.textContent = '送信';
  }
});

  </script>
</body>
</html>