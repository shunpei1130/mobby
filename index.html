<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mobby（モビィ）</title>
  <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --color-cream:#FFF8E7;
    --color-forest:#2F4F4F;
    --color-sky:#AEC6CF;
    --color-earth:#8B4513;
    --color-accent-red:#D2691E;
    --color-soft-yellow:#F0E68C;
  
    --font-ja:'Kosugi Maru', sans-serif;
    --font-en:'Nunito', sans-serif;
    --ease-soft:cubic-bezier(0.4, 0.0, 0.2, 1);
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  
  body{
    font-family:var(--font-ja);
    background-color:var(--color-cream);
    color:var(--color-forest);
    overflow-x:hidden;
    line-height:1.7;
    overflow-y:hidden; /* splash中 */
  }
  
  #splash-screen.hidden{opacity:0;visibility:hidden;pointer-events:none;}
  
/* Splash */
#splash-screen{
  position:fixed;
  inset:0;
  z-index:9999;
  cursor:pointer;
  transition:opacity 1.2s ease-out, visibility 1.2s ease-out;
  overflow:hidden;

  /* ▼ 小さく表示＋余白は白 */
  background-color:#f9f5f4;                 /* 余白を白に */
  background-image:url('favicon/背景.jpg');
  background-repeat:no-repeat;
  background-position:center;
  background-size: 50% auto;   /* 横幅70%で固定 */
         /* 拡大しない・必ず収まる */
}

/* 暗くするforest色オーバーレイは完全に不要 */
#splash-screen::before{
  display:none;
}



  #splash-screen canvas{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    z-index:1;
  }
  
  .instruction{
    position:absolute;top:60%;left:50%;transform:translateX(-50%);
    color:rgba(255,255,255,0.9);pointer-events:none;
    font-family:var(--font-en), var(--font-ja);font-weight:700;font-size:1rem;
    letter-spacing:0.04em;padding:10px 14px;border-radius:999px;
    background:rgba(255,255,255,0.12);backdrop-filter:blur(8px);
    user-select:none;white-space:nowrap;
    z-index:3;
  }
  
  #main-content{opacity:0;transition:opacity 1.5s ease;}
  #main-content.visible{opacity:1;}
  
  h1,h2,h3{
    font-family:var(--font-en), var(--font-ja);
    font-weight:700;letter-spacing:0.05em;line-height:1.2;
    color:var(--color-earth);
  }
  p{font-weight:400;letter-spacing:0.02em;}
  .container{max-width:1050px;margin:0 auto;padding:0 30px;}
  
  .btn{
    display:inline-block;padding:12px 35px;border-radius:255px 15px 225px 15px / 15px 225px 15px 255px;
    text-decoration:none;font-size:16px;font-weight:700;font-family:var(--font-en);
    transition:all 0.4s var(--ease-soft);border:2px solid transparent;
    box-shadow:3px 3px 0 rgba(0,0,0,0.1);cursor:pointer;
  }
  .btn-secondary{background-color:var(--color-cream);color:var(--color-forest);border-color:var(--color-forest);}
  .btn-secondary:hover{background-color:var(--color-sky);color:#fff;border-color:transparent;transform:translateY(-2px) rotate(-1deg);}
  .btn-primary{background-color:var(--color-accent-red);color:var(--color-cream);}
  .btn-primary:hover{background-color:var(--color-earth);transform:translateY(-2px) rotate(1deg);}
  .btn-ghost{background:rgba(255,255,255,0);color:var(--color-forest);border-color:rgba(47,79,79,0.35);}
  .btn-ghost:hover{background:rgba(174,198,207,0.35);border-color:transparent;transform:translateY(-2px);}
  
  .tag{
    display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;
    font-weight:700;letter-spacing:.04em;font-family:var(--font-en), var(--font-ja);
    background:rgba(174,198,207,0.35);color:var(--color-forest);
    border:1px solid rgba(47,79,79,0.18);
  }
  .trust-row{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin-top:16px;}
  .trust-pill{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.7);border:1px solid rgba(47,79,79,0.12);font-weight:700;font-size:0.9rem;}
  
  .reveal{opacity:0;transform:translateY(30px);transition:opacity 1s var(--ease-soft), transform 1s var(--ease-soft);}
  .reveal.active{opacity:1;transform:translateY(0);}
  .delay-200{transition-delay:0.2s;}
  .delay-400{transition-delay:0.4s;}
  
  /* Hero */
  .hero{
    display:flex;flex-direction:column;justify-content:center;align-items:center;
    text-align:center;position:relative;padding-top:92px;padding-bottom:52px;
  }

  .headline{font-size:clamp(2.2rem, 3.9vw, 3.2rem);margin-top:12px;}
  .subhead{margin-top:12px;font-size:1.02rem;opacity:0.92;}
  
  @keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-10px);}}
  .floating{animation:float 4s ease-in-out infinite;}
  
  .cta-row{margin-top:20px;display:flex;flex-wrap:wrap;gap:12px;justify-content:center;}
  .status-row{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:14px;}
  .status-chip{
    display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:18px;
    background:rgba(255,255,255,0.78);border:1px solid rgba(47,79,79,0.12);
    box-shadow:3px 3px 0 rgba(0,0,0,0.06);font-family:var(--font-en), var(--font-ja);font-weight:700;
  }
  .status-chip strong{color:var(--color-earth);}
  
  /* Creator message */
  .hero-quote{
    width:min(920px, 100%);
    margin:0 auto 14px;
    text-align:left;
    border-radius:30px;
    padding:26px 22px;
    background:rgba(255,255,255,0.86);
    border:1px solid rgba(47,79,79,0.14);
    box-shadow:0 18px 45px rgba(0,0,0,0.10);
  }
  .hero-quote .label{
    font-weight:800;
    color:var(--color-earth);
    font-family:var(--font-en), var(--font-ja);
    margin-bottom:12px;
    letter-spacing:0.08em;
    font-size:1.15rem;
  }
  .hero-quote .creator-text{
    font-size:1.15rem;
    line-height:1.95;
    opacity:0.96;
  }
  @media (max-width: 768px){
    .hero-quote{padding:20px 16px;border-radius:26px;}
    .hero-quote .label{font-size:1.05rem;}
    .hero-quote .creator-text{font-size:1.02rem;line-height:1.9;}
  }
  
  /* ===== Hero Carousel (3D Rotating Ring) ===== */
  .hero-carousel{
    width:min(460px, 96vw);
    margin:14px auto 10px;
    position:relative;
    user-select:none;
    touch-action: pan-y;
    perspective: 1300px;
  }
  .carousel-viewport{position:relative;height:330px;overflow: visible;}
  .carousel-track{
    position:absolute;left:50%;top:50%;
    transform-style: preserve-3d;
    transition: transform 0.7s var(--ease-soft);
    will-change: transform;
  }
  .carousel-slide{
    position:absolute;left:0;top:0;
    width:330px;height:330px;
    transform-style: preserve-3d;
    transition: opacity 0.35s var(--ease-soft), filter 0.35s var(--ease-soft);
    cursor: pointer;
  }
  .carousel-slide.dim{opacity: 0.55;filter: blur(0.6px);}
  .hero-illustration{
    width:100%;height:100%;
    background: transparent;border: none;border-radius: 20px;
    overflow: hidden;
    position: relative;
  }
  .hero-illustration img{width:100%;height:100%;object-fit: cover;}
  
  /* カルーセル内のホットスポット */
  .carousel-eye-hotspot{
    position:absolute;
    top:25%;
    left:58%;
    width:22%;
    min-width:52px;
    height:auto;
    min-height:52px;
    aspect-ratio:1/1;
    border-radius:50%;
    background:rgba(255,255,255,0.01);
    border:none;
    cursor:pointer;
    z-index:15;
    pointer-events:auto;
    transform:translateZ(0);
  }
  .carousel-eye-hotspot:hover{outline:2px solid rgba(255,255,255,0.4);}
  .carousel-eye-hotspot::before{
    content:"";
    position:absolute;
    inset:-18%;
    border-radius:50%;
    border:2px dashed rgba(255,255,255,0.65);
    animation:pulse 2.2s ease-in-out infinite;
  }
  .carousel-eye-shutter{
    position:absolute;
    top:34%;
    left:58%;
    width:22%;
    aspect-ratio:1/1;
    border-radius:50%;
    pointer-events:none;
    z-index:16;
    background:
      conic-gradient(
        from 0deg,
        #111 0 10%,
        #222 10% 20%,
        #111 20% 30%,
        #222 30% 40%,
        #111 40% 50%,
        #222 50% 60%,
        #111 60% 70%,
        #222 70% 80%,
        #111 80% 90%,
        #222 90% 100%
      );
    transform:scale(0);
    opacity:0;
  }
  .carousel-eye-shutter.play{animation: shutter 220ms ease-in-out forwards;}
  
  .carousel-btn{
    position:absolute;top:50%;transform:translateY(-50%);
    width:44px;height:44px;border-radius:999px;
    border:1px solid rgba(47,79,79,0.18);
    background:rgba(255,255,255,0.75);
    color:var(--color-forest);
    font-size:26px;font-weight:700;
    cursor:pointer;z-index:10;
    display:flex;align-items:center;justify-content:center;
    transition:transform .2s var(--ease-soft), background .2s var(--ease-soft);
    box-shadow:3px 3px 0 rgba(0,0,0,0.06);
  }
  .carousel-btn:hover{transform:translateY(-50%) scale(1.04);background:rgba(255,255,255,0.88);}
  .carousel-btn.prev{left:-10px;}
  .carousel-btn.next{right:-10px;}
  
  .carousel-caption{
    margin-top:10px;display:inline-block;
    font-family:var(--font-en), var(--font-ja);
    font-weight:700;color:var(--color-forest);
    background:rgba(255,255,255,0.78);
    border:1px solid rgba(47,79,79,0.12);
    box-shadow:3px 3px 0 rgba(0,0,0,0.04);
    padding:6px 10px;border-radius:999px;
  }
  .carousel-dots{display:flex;justify-content:center;gap:8px;margin-top:10px;}
  .carousel-dot{
    width:10px;height:10px;border-radius:999px;
    border:1px solid rgba(47,79,79,0.18);
    background:rgba(255,255,255,0.55);
    cursor:pointer;
  }
  .carousel-dot.active{background:rgba(240,230,140,0.75);border-color:rgba(240,230,140,0.95);}
  @media (max-width: 768px){
    .carousel-viewport{height:250px;}
    .carousel-slide{width:250px;height:250px;}
    .carousel-btn{width:40px;height:40px;font-size:24px;}
  }
  
  /* Sections */
  .section.center{text-align:center;}
  .lead{margin-top:14px;font-size:1.0rem;opacity:0.92;}
  
  .grid-3{display:grid;grid-template-columns:repeat(3, minmax(0, 1fr));gap:18px;margin-top:24px;}
  .card{
    background:rgba(255,255,255,0.85);border:1px solid rgba(47,79,79,0.12);
    border-radius:26px;padding:18px 16px;box-shadow:3px 3px 0 rgba(0,0,0,0.06);text-align:left;
  }
  .card h3{font-size:1.1rem;margin-bottom:6px;}
  .card p{font-size:0.95rem;opacity:0.92;}
  
  /* Colors */
  #colors{scroll-margin-top:90px;}
  .colors-grid{
    display:grid;grid-template-columns:repeat(4, minmax(0, 1fr));
    gap:14px;margin-top:18px;text-align:left;
  }
  .color-card{
    border-radius:26px;padding:16px 14px;border:1px solid rgba(47,79,79,0.14);
    background:rgba(255,255,255,0.86);box-shadow:3px 3px 0 rgba(0,0,0,0.06);
    cursor:pointer;transition:transform .25s var(--ease-soft), box-shadow .25s var(--ease-soft), border-color .25s var(--ease-soft);
    position:relative;user-select:none;outline:none;
  }
  .color-card:hover{transform:translateY(-2px);}
  .color-card.selected{
    border-color:rgba(210,105,30,0.55);
    box-shadow:0 14px 30px rgba(0,0,0,0.12);
    transform:translateY(-3px);
  }
  .selected-badge{
    position:absolute;top:12px;right:12px;padding:6px 10px;border-radius:999px;
    font-weight:700;font-size:.85rem;background:rgba(240,230,140,0.55);
    border:1px solid rgba(139,69,19,0.18);color:var(--color-earth);display:none;
  }
  .color-card.selected .selected-badge{display:inline-block;}
  .swatch{
    width:44px;height:44px;border-radius:999px;border:2px solid rgba(47,79,79,0.18);
    box-shadow:inset 0 0 0 3px rgba(255,255,255,0.65);margin-bottom:10px;
  }
  .color-title{
    font-weight:700;font-family:var(--font-en), var(--font-ja);color:var(--color-earth);
    display:flex;align-items:center;gap:8px;flex-wrap:wrap;
  }
  .mini-tag{
    display:inline-block;padding:5px 9px;border-radius:999px;font-size:.85rem;font-weight:700;
    background:rgba(174,198,207,0.25);border:1px solid rgba(47,79,79,0.12);
    color:var(--color-forest);white-space:nowrap;
  }
  .color-desc{margin-top:8px;font-size:.92rem;opacity:.9;}
  .product-thumb{
    width:100%;aspect-ratio:1/1;border-radius:18px;margin:10px 0 6px;
    border:1px solid rgba(47,79,79,0.12);
    box-shadow:0 10px 25px rgba(0,0,0,0.06);
    object-fit:cover;background:#fff;
  }
  
  .steps{display:grid;grid-template-columns:repeat(3, minmax(0, 1fr));gap:18px;margin-top:26px;text-align:left;}
  .step{position:relative;overflow:hidden;}
  .step .num{font-family:var(--font-en);font-size:2.1rem;font-weight:700;opacity:0.18;position:absolute;top:8px;right:14px;}
  .step .title{font-weight:700;font-family:var(--font-en), var(--font-ja);color:var(--color-earth);margin-bottom:6px;font-size:1.05rem;}
  .step .mini{font-size:0.95rem;opacity:0.92;}
  
  .pricing{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:18px;text-align:left;}
  .price-card{
    border-radius:26px;padding:18px 16px;border:1px solid rgba(47,79,79,0.12);
    background:rgba(255,255,255,0.86);box-shadow:3px 3px 0 rgba(0,0,0,0.06);
  }
  .price-card .label{
    font-weight:700;font-family:var(--font-en), var(--font-ja);color:var(--color-earth);
    display:flex;align-items:center;gap:10px;
  }
  .price-card .value{font-size:1.6rem;font-weight:700;margin-top:10px;color:var(--color-forest);font-family:var(--font-en), var(--font-ja);}
  .badge{
    display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:0.85rem;
    background:rgba(240,230,140,0.45);border:1px solid rgba(139,69,19,0.18);
    color:var(--color-earth);white-space:nowrap;
  }
  
  .notice{
    margin-top:14px;padding:12px 14px;border-radius:18px;background:rgba(255,248,231,0.75);
    border:1px dashed rgba(139,69,19,0.25);font-size:0.92rem;text-align:left;
  }
  
  .buy-preview{
    max-width:820px;margin:14px auto 0;
    display:flex;gap:14px;align-items:center;justify-content:center;flex-wrap:wrap;
  }
  .buy-preview img{
    width:140px;height:140px;border-radius:22px;object-fit:cover;
    border:1px solid rgba(47,79,79,0.12);
    box-shadow:0 12px 25px rgba(0,0,0,0.08);
    background:#fff;
  }
  
  /* FAQ */
  .faq{margin-top:18px;text-align:left;}
  details.faq-item{
    background:rgba(255,255,255,0.84);border:1px solid rgba(47,79,79,0.12);
    border-radius:18px;padding:14px 14px;margin-top:10px;box-shadow:3px 3px 0 rgba(0,0,0,0.04);
  }
  details.faq-item summary{cursor:pointer;font-weight:700;color:var(--color-earth);font-family:var(--font-en), var(--font-ja);list-style:none;}
  details.faq-item summary::-webkit-details-marker{display:none;}
  details.faq-item p{margin-top:10px;opacity:0.92;}
  
  /* Sticky CTA */
  .sticky-cta{
    position:fixed;left:0;right:0;bottom:12px;z-index:50;display:none;pointer-events:none;
  }
  .sticky-cta .inner{max-width:1050px;margin:0 auto;padding:0 16px;display:flex;justify-content:center;}
  .sticky-cta .bar{
    pointer-events:auto;width:min(900px, 100%);background:rgba(255,255,255,0.82);
    border:1px solid rgba(47,79,79,0.16);backdrop-filter:blur(10px);border-radius:999px;
    padding:10px 12px;box-shadow:0 12px 30px rgba(0,0,0,0.12);
    display:flex;gap:10px;align-items:center;justify-content:space-between;
  }
  .sticky-cta .txt{font-weight:700;font-family:var(--font-en), var(--font-ja);color:var(--color-forest);padding-left:6px;font-size:0.95rem;}
  .sticky-cta .btn{padding:10px 18px;font-size:0.95rem;}
  
  footer{background-color:var(--color-forest);padding:56px 0;text-align:center;color:var(--color-cream);}
  .footer-links a{color:var(--color-sky);text-decoration:none;margin:0 12px;font-weight:700;}
  
  /* ポップアップボタンバー（最下部） */
  .popup-buttons-bar{
    background-color:var(--color-cream);
    padding:24px 0;
  }
  .popup-buttons{
    display:flex;
    flex-wrap:nowrap;
    gap:12px;
    justify-content:center;
    align-items:center;
  }
  .popup-buttons .btn{
    width:80px;
    height:80px;
    padding:0;
    display:flex;
    align-items:center;
    justify-content:center;
    aspect-ratio:1/1;
    border-radius:18px;
  }
  
  /* ポップアップオーバーレイ */
  .popup-overlay{
    position:fixed;
    inset:0;
    z-index:99998;
    display:none;
    background:rgba(47,79,79,0.85);
    backdrop-filter:blur(4px);
    overflow-y:auto;
    padding:20px;
  }
  .popup-overlay.is-open{
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .popup-content{
    position:relative;
    background:var(--color-cream);
    border-radius:30px;
    padding:40px 30px;
    max-width:900px;
    width:100%;
    max-height:90vh;
    overflow-y:auto;
    box-shadow:0 20px 60px rgba(0,0,0,0.3);
    margin:auto;
  }
  .popup-close{
    position:absolute;
    top:16px;
    right:16px;
    width:44px;
    height:44px;
    border-radius:999px;
    border:2px solid rgba(47,79,79,0.18);
    background:rgba(255,255,255,0.85);
    color:var(--color-forest);
    font-size:28px;
    font-weight:700;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:all 0.2s var(--ease-soft);
    z-index:10;
  }
  .popup-close:hover{
    background:rgba(174,198,207,0.35);
    transform:scale(1.05);
  }
  @media (max-width: 768px){
    .popup-content{
      padding:30px 20px;
      border-radius:24px;
    }
    .popup-buttons{
      flex-wrap:wrap;
      gap:10px;
    }
    .popup-buttons .btn{
      width:70px;
      height:70px;
      max-width:none;
    }
  }
  
  @media (max-width: 900px){
    .pricing{grid-template-columns:1fr;}
    .colors-grid{grid-template-columns:repeat(2, minmax(0, 1fr));}
  }
  @media (max-width: 768px){
    .hero-carousel{width:min(320px, 92vw);}
    .grid-3,.steps{grid-template-columns:1fr;}
    .sticky-cta .txt{display:none;}
    .sticky-cta .bar{justify-content:center;}
  }
  
  /* ===== TRY DEMO ===== */
  .try-wrap{max-width:860px;margin:18px auto 0;}
  .try-card{
    width:100%;
    border:1px solid rgba(47,79,79,0.12);
    background:rgba(255,255,255,0.86);
    border-radius:26px;
    padding:14px;
    box-shadow:3px 3px 0 rgba(0,0,0,0.06);
    cursor:pointer;
    text-align:left;
    transition:transform .25s var(--ease-soft), box-shadow .25s var(--ease-soft);
    position:relative;
  }
  .try-card:hover{transform:translateY(-2px);box-shadow:0 14px 30px rgba(0,0,0,0.12);}
  .try-img{
    width:100%;
    height:auto;
    border-radius:18px;
    display:block;
    border:1px solid rgba(47,79,79,0.10);
    box-shadow:0 12px 25px rgba(0,0,0,0.08);
    background:#fff;
  }
  .try-badge{
    position:absolute;top:24px;right:24px;
    padding:6px 10px;border-radius:999px;
    font-weight:800;font-family:var(--font-en), var(--font-ja);
    background:rgba(0,0,0,0.45);color:#fff;
    border:1px solid rgba(255,255,255,0.18);
  }
  .try-text{margin-top:12px;}
  .try-title{font-weight:800;color:var(--color-earth);font-family:var(--font-en), var(--font-ja);}
  .try-sub{font-size:.95rem;opacity:.85;margin-top:4px;}
  
  /* ===== Overlay base ===== */
  .vf{
    position:fixed;inset:0;z-index:99999;
    display:none;color:var(--color-cream);
  }
  .vf.is-open{display:block;}
  .vf-backdrop{
    position:absolute;inset:0;
    background:rgba(47,79,79,0.78);
    backdrop-filter: blur(2px);
    z-index:1;
  }
  .vf-top, .vf-footer, .vf-stage{ position: relative; z-index: 2; }
  
  .vf-top{
    display:flex;justify-content:space-between;gap:12px;
    padding:14px 16px;
  }
  .vf-meta{display:grid;gap:4px;}
  .vf-counter{
    font-weight:900;letter-spacing:.04em;
    font-family:var(--font-en), var(--font-ja);
    color:var(--color-soft-yellow);
  }
  .vf-sub{font-size:12px;opacity:.85;max-width:72ch;}
  .vf-close{min-width:52px;min-height:44px;display:flex;align-items:center;justify-content:center;}
  .vf-footer{
    position:absolute;left:50%;bottom:18px;
    transform:translateX(-50%);
  }
  .vf-tip{
    display:inline-block;
    padding:8px 12px;border-radius:999px;
    background:rgba(255,255,255,0.12);
    border:1px solid rgba(255,255,255,0.14);
    font-size:12px;opacity:.95;
    backdrop-filter: blur(10px);
    white-space:nowrap;
  }
  @media (max-width:768px){
    .vf-tip{white-space:normal;text-align:center;}
  }
  
  /* ===== Eye tap (right eye hotspot) ===== */
  .eye-tap-wrap{
    position:relative;
    width:260px;
    margin:0 auto;
  }
  .eye-tap-img{width:100%;height:auto;display:block;}
  
  .eye-hotspot{
    position:absolute;
    top:25%;
    left:58%;
    width:22%;
    aspect-ratio:1/1;
    border-radius:50%;
    background:rgba(255,255,255,0.01);
    border:none;
    cursor:pointer;
    z-index:3;
  }
  .eye-hotspot:hover{outline:2px solid rgba(255,255,255,0.4);}
  .eye-hotspot::before{
    content:"";
    position:absolute;
    inset:-18%;
    border-radius:50%;
    border:2px dashed rgba(255,255,255,0.65);
    animation:pulse 2.2s ease-in-out infinite;
  }
  .eye-hint{
    position:absolute;
    top:26%;
    left:58%;
    transform:translate(-50%, -100%);
    font-size:0.8rem;
    font-weight:700;
    padding:6px 10px;
    border-radius:999px;
    background:rgba(0,0,0,0.55);
    color:#fff;
    white-space:nowrap;
    z-index:4;
  }
  @keyframes pulse{
    0%{transform:scale(0.9);opacity:0.2;}
    50%{transform:scale(1.05);opacity:0.8;}
    100%{transform:scale(0.9);opacity:0.2;}
  }
  
  /* ===== Eye Shutter ===== */
  .eye-shutter{
    position:absolute;
    top:34%;
    left:58%;
    width:22%;
    aspect-ratio:1/1;
    border-radius:50%;
    pointer-events:none;
    z-index:5;
    background:
      conic-gradient(
        from 0deg,
        #111 0 10%,
        #222 10% 20%,
        #111 20% 30%,
        #222 30% 40%,
        #111 40% 50%,
        #222 50% 60%,
        #111 60% 70%,
        #222 70% 80%,
        #111 80% 90%,
        #222 90% 100%
      );
    transform:scale(0);
    opacity:0;
  }
  .eye-shutter.play{animation: shutter 220ms ease-in-out forwards;}
  @keyframes shutter{
    0%{transform:scale(0.1);opacity:0;}
    40%{transform:scale(1.05);opacity:1;}
    70%{transform:scale(0.95);opacity:1;}
    100%{transform:scale(0);opacity:0;}
  }
  
  /* ===== Retro Camera (Overlay内) ===== */
  #vfOverlay .vf-stage{
    position:relative;
    z-index:2;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:14px;
    padding: 8px 16px 22px;
    height: calc(100vh - 64px);
  }
  
  #vfOverlay .rc-camera-body{
    position:relative;
    width:min(86vw, 520px);
    aspect-ratio:1/1;
    background:#1a1a1c;
    box-shadow: inset 0 0 50px #000;
    border-radius:8px;
    overflow:hidden;
    background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.06'/%3E%3C/svg%3E");
  }
  
  #vfOverlay .rc-viewfinder{
    position:absolute;
    inset: 8.5%;
    background:#050505;
    box-shadow: inset 0 0 80px rgba(0,0,0,1);
    overflow:hidden;
    perspective: 1000px;
    border-radius:6px;
  }
  
  /* うっすら夜プリ系の色ムード */
  #vfOverlay .rc-viewfinder::after{
    content:"";
    position:absolute; inset:0;
    background: linear-gradient(180deg, rgba(255,200,220,0.07), rgba(140,160,255,0.06));
    mix-blend-mode: screen;
    pointer-events:none;
    z-index:90;
  }
  
  #vfOverlay .rc-photo-layer{
    position:absolute;
    inset:0;
    z-index:10;
  }
  
  #vfOverlay .rc-polaroid{
    position:absolute;
    background:#fdfbf7;
    padding:10px 10px 35px 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.6);
    transition: all 0.8s cubic-bezier(0.25, 0.8, 0.25, 1);
    width: 140px;
    will-change: transform, opacity, filter;
    border-radius: 2px 3px 4px 2px;
  }
  #vfOverlay .rc-polaroid img{
    display:block;
    width:100%;
    height:140px;
    object-fit:cover;
    user-select:none;
    -webkit-user-drag:none;
  
    /* “エモ”フィルム寄せ */
    filter:
      contrast(1.15)
      brightness(0.95)
      saturate(1.15)
      sepia(0.18)
      hue-rotate(-4deg);
  }
  
  /* 粒子 */
  #vfOverlay .rc-polaroid::after{
    content:"";
    position:absolute;
    inset:0;
    background:
      url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.08'/%3E%3C/svg%3E");
    mix-blend-mode: overlay;
    pointer-events:none;
  }
  
  /* age states */
  #vfOverlay .rc-age-0{
    top:50%; left:50%;
    transform: translate(-50%, -50%) rotate(1.5deg) scale(1.12);
    z-index:50; opacity:1;
    filter: contrast(1.1) brightness(1.05);
    box-shadow: 0 22px 60px rgba(0,0,0,0.92);
  }
  #vfOverlay .rc-age-1{
    top: 8%; left: 6%;
    transform: rotate(-6deg) scale(0.95);
    z-index:40; opacity:0.95;
    filter: sepia(0.2) contrast(1);
  }
  #vfOverlay .rc-age-2{
    top: 6%; right: 6%;
    transform: rotate(4deg) scale(0.90);
    z-index:30; opacity:0.85;
    filter: sepia(0.4) brightness(0.9);
  }
  #vfOverlay .rc-age-3{
    bottom: 10%; left: 7%;
    transform: rotate(8deg) scale(0.85);
    z-index:20; opacity:0.7;
    filter: sepia(0.6) grayscale(0.45) brightness(0.82);
  }
  #vfOverlay .rc-age-4{
    bottom: 7%; right: 5%;
    transform: rotate(-5deg) scale(0.80);
    z-index:10; opacity:0.4;
    filter: sepia(0.82) grayscale(0.8) blur(2px);
  }
  
  /* overlays */
  #vfOverlay .rc-overlay-texture{
    position:absolute; inset:0;
    pointer-events:none;
    z-index:100;
    mix-blend-mode:overlay;
    opacity:0.55;
    background: radial-gradient(circle, transparent 30%, #000 130%);
  }
  #vfOverlay .rc-dust{
    position:absolute;
    background: rgba(255, 255, 255, 0.45);
    border-radius:50%;
    pointer-events:none;
    z-index:101;
  }
  #vfOverlay .rc-lens-reflection{
    position:absolute;
    bottom:-80px; left:50%;
    transform:translateX(-50%);
    width:80%; height:150px;
    background: radial-gradient(ellipse at center, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0) 70%);
    border-radius:50%;
    z-index:110;
    border-top: 1px solid rgba(255,255,255,0.12);
    filter: blur(2px);
    pointer-events:none;
  }
  
  #vfOverlay .rc-controls{
    text-align:center;
    display:grid;
    gap:10px;
  }
  #vfOverlay .rc-snap{
    background:#cc3333;
    color:#fff;
    border:none;
    padding:12px 24px;
    font-size:16px;
    border-radius:30px;
    cursor:pointer;
    box-shadow:0 6px 16px rgba(204, 51, 51, 0.38);
    font-family: var(--font-en), var(--font-ja);
    font-weight:900;
    letter-spacing:0.10em;
  }
  #vfOverlay .rc-snap:active{ transform: scale(0.97); background:#aa2222; }
  #vfOverlay .rc-hint{
    font-size:12px;
    opacity:0.82;
    color: rgba(255,255,255,0.82);
  }
  

</style>
</head>

<body>
  <!-- Splash -->
  <div id="splash-screen">
    <div class="instruction">TAP！！</div>
  </div>

  <div id="main-content">
    <section class="hero">
      <div class="container reveal">



        <!-- 4色カルーセル -->
        <div class="hero-carousel floating reveal delay-200" id="heroCarousel" aria-label="Mobby カラーギャラリー">
          <button class="carousel-btn prev" type="button" aria-label="前の色">‹</button>

          <div class="carousel-viewport">
            <div class="carousel-track" id="heroTrack">
              <div class="carousel-slide" data-color="pink">
                <div class="hero-illustration"><img src="mobby_pink.jpg" alt="Mobby Peach Pink"></div>
              </div>
              <div class="carousel-slide" data-color="purple">
                <div class="hero-illustration"><img src="mobby_purple.jpg" alt="Mobby Twilight Violet"></div>
              </div>
              <div class="carousel-slide" data-color="blue">
                <div class="hero-illustration"><img src="mobby_blue.jpg" alt="Mobby Aqua Sky"></div>
              </div>
              <div class="carousel-slide" data-color="orange">
                <div class="hero-illustration"><img src="mobby_orange.jpg" alt="Mobby Sunny Orange"></div>
              </div>
            </div>
          </div>

          <button class="carousel-btn next" type="button" aria-label="次の色">›</button>

          <div class="carousel-caption" id="heroCaption">Peach Pink</div>
          <div class="carousel-dots" id="heroDots" role="tablist" aria-label="カラーを選ぶ"></div>
        </div>

        <h1 class="headline reveal delay-200">5枚だけ、残せる。</h1>
      </div>
    </section>


<!-- Viewfinder Overlay -->

<div id="vfOverlay" class="vf" aria-hidden="true">
  <div class="vf-top">
    <div class="vf-meta">
      <div class="vf-counter" id="vfCounter">5 / 5</div>
      <div class="vf-sub">新しい写真を撮ると、古い写真は隅へ。いちばん古い1枚は消える。</div>
    </div>
    <button class="btn btn-ghost vf-close" id="vfClose" type="button" aria-label="閉じる">×</button>
  </div>

  <div class="vf-backdrop" id="vfBackdrop"></div>

  <!-- ★ Retro Camera 本体 -->
  <div class="vf-stage" role="application" aria-label="Retro Camera Demo">
    <div class="rc-camera-body">
      <div class="rc-viewfinder" id="rcViewfinder">
        <div class="rc-photo-layer" id="rcPhotoContainer"></div>
        <div class="rc-overlay-texture"></div>
        <div class="rc-lens-reflection"></div>
      </div>
    </div>

    <div class="rc-controls">
      <button class="rc-snap" id="rcSnap" type="button" aria-label="シャッター">SNAP SHUTTER</button>
      <div class="rc-hint">いっぱい残せない。だから、残るのは今の5つだけ。</div>
    </div>
  </div>
</div>


    <!-- COLORS ポップアップ -->
    <div id="colorsPopup" class="popup-overlay" aria-hidden="true">
      <div class="popup-content">
        <button class="popup-close" id="closeColorsPopup" aria-label="閉じる">×</button>
        <div class="container">
          <h2>4色</h2>
          <p class="lead">雰囲気で選べる。</p>

          <div class="colors-grid reveal delay-200" role="list">
            <div class="color-card selected" role="listitem" tabindex="0" data-color="pink">
              <div class="selected-badge">選択中</div>
              <div class="swatch" style="background:#F7A7C6;"></div>
              <div class="color-title">Peach Pink <span class="mini-tag">直感</span></div>
              <img class="product-thumb" src="mobby_pink.jpg" alt="Mobby Peach Pink">
              <div class="color-desc">好きに正直。</div>
            </div>

            <div class="color-card" role="listitem" tabindex="0" data-color="purple">
              <div class="selected-badge">選択中</div>
              <div class="swatch" style="background:#9C7BFF;"></div>
              <div class="color-title">Twilight Violet <span class="mini-tag">世界観</span></div>
              <img class="product-thumb" src="mobby_purple.jpg" alt="Mobby Twilight Violet">
              <div class="color-desc">こだわり強め。</div>
            </div>

            <div class="color-card" role="listitem" tabindex="0" data-color="blue">
              <div class="selected-badge">選択中</div>
              <div class="swatch" style="background:#8FD7FF;"></div>
              <div class="color-title">Aqua Sky <span class="mini-tag">冒険</span></div>
              <img class="product-thumb" src="mobby_blue.jpg" alt="Mobby Aqua Sky">
              <div class="color-desc">フッ軽。</div>
            </div>

            <div class="color-card" role="listitem" tabindex="0" data-color="orange">
              <div class="selected-badge">選択中</div>
              <div class="swatch" style="background:#FFA24A;"></div>
              <div class="color-title">Sunny Orange <span class="mini-tag">勇気</span></div>
              <img class="product-thumb" src="mobby_orange.jpg" alt="Mobby Sunny Orange">
              <div class="color-desc">前に進める。</div>
            </div>
          </div>

          <div class="notice reveal delay-200">
            <strong>選択中：</strong><span id="selectedColorText">Peach Pink</span>
          </div>

          <div class="cta-row reveal delay-200" style="margin-top:16px;">
            <a href="#buy" class="btn btn-primary">この色で買う</a>
            <button class="btn btn-ghost" id="openPriceFromColors">値段</button>
          </div>
        </div>
      </div>
    </div>


    <!-- PRICE ポップアップ -->
    <div id="pricePopup" class="popup-overlay" aria-hidden="true">
      <div class="popup-content">
        <button class="popup-close" id="closePricePopup" aria-label="閉じる">×</button>
        <div class="container">
          <h2>値段</h2>
          <p class="lead">学生は安く。</p>

          <div class="pricing reveal delay-200">
            <div class="price-card">
              <div class="label">通常 <span class="badge">¥8,000</span></div>
              <div class="value">¥8,000</div>
            </div>
            <div class="price-card">
              <div class="label">学生 <span class="badge">¥4,000</span></div>
              <div class="value">¥4,000</div>
            </div>
          </div>

          <div class="notice reveal delay-200">
            <strong>支払い完了＝確保。</strong> 1月末に順番に発送。
          </div>
        </div>
      </div>
    </div>

    <!-- FAQ ポップアップ -->
    <div id="faqPopup" class="popup-overlay" aria-hidden="true">
      <div class="popup-content">
        <button class="popup-close" id="closeFaqPopup" aria-label="閉じる">×</button>
        <div class="container">
          <h2>よくある質問</h2>
          <p class="lead">不安はここで消す。</p>

          <div class="faq reveal delay-200">
            <details class="faq-item">
              <summary>いつ届くの？</summary>
              <p>次回入荷（1月末）後、順番にお届けします。支払いが完了した分は必ず用意します。</p>
            </details>
            <details class="faq-item">
              <summary>本当に届くの？</summary>
              <p>はい。支払いが完了した時点で、あなたの分を確保します。もしこちらの都合で用意できない場合は全額返金します。</p>
            </details>
            <details class="faq-item">
              <summary>学生さんの値段ってどうやって？</summary>
              <p>学生向けリンク（クーポン適用済み）から購入します。</p>
            </details>
            <details class="faq-item">
              <summary>6枚目を撮るとどうなる？</summary>
              <p>新しく撮ると、いちばん古い写真から順に自動で消えていきます（最大5枚）。</p>
            </details>
          </div>

          <div class="cta-row reveal delay-200" style="margin-top:22px;">
            <button class="btn btn-primary" id="openColorsFromFaq">色を選ぶ</button>
            <a href="#buy" class="btn btn-secondary">買う</a>
          </div>
        </div>
      </div>
    </div>

    <!-- 文章（message from the creator）ポップアップ -->
    <div id="messagePopup" class="popup-overlay" aria-hidden="true">
      <div class="popup-content">
        <button class="popup-close" id="closeMessagePopup" aria-label="閉じる">×</button>
        <div class="container">
          <div class="hero-quote">
            <div class="label">message from the creator</div>
            <p class="creator-text">
              水溜りに移り込んだ空は、やがて小さくなっていき、消えてゆく。窓の中の小さな夜を、いつまでも閉じ込めてしまいたいと、どれだけ強く願ってみても、そこに永遠はない。あなたが幸せな時に、あなたが苦しい時に、あなたが頑張りたい時に、いつもそばにいるのは、モビー。
            </p>
          </div>
        </div>
      </div>
    </div>

    
    <!-- ポップアップボタン（最下部） -->
    <div class="popup-buttons-bar">
      <div class="container">
        <div class="popup-buttons">
          <button class="btn btn-secondary" id="openMessagePopup">文章</button>
          <button class="btn btn-secondary" id="openColorsPopup">4色</button>
          <button class="btn btn-secondary" id="openPricePopup">値段</button>
          <button class="btn btn-secondary" id="openFaqPopup">FAQ</button>
        </div>
      </div>
    </div>
  </div>



  <!-- Matter.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

  <script>
/* reveal */
function initScrollObserver(){
  const revealElements = document.querySelectorAll('.reveal');
  const options = { root:null, rootMargin:'0px', threshold:0.15 };
  const observer = new IntersectionObserver((entries, obs) => {
    entries.forEach(entry => {
      if(entry.isIntersecting){
        entry.target.classList.add('active');
        obs.unobserve(entry.target);
      }
    });
  }, options);
  revealElements.forEach(el => observer.observe(el));
}

/* Stripeリンク（色ごと） */
const STRIPE_URLS = {
  regular: { pink:"https://forms.gle/2PWsZu9sZntjCmVs7", purple:"https://forms.gle/2PWsZu9sZntjCmVs7", blue:"https://forms.gle/2PWsZu9sZntjCmVs7", orange:"https://forms.gle/2PWsZu9sZntjCmVs7" },
  student: { pink:"https://forms.gle/2PWsZu9sZntjCmVs7", purple:"https://forms.gle/2PWsZu9sZntjCmVs7", blue:"https://forms.gle/2PWsZu9sZntjCmVs7", orange:"https://forms.gle/2PWsZu9sZntjCmVs7" }
};

/* 色メタ */
const COLOR_META = {
  pink:   { name:"Peach Pink",      img:"mobby_pink.jpg"   },
  purple: { name:"Twilight Violet", img:"mobby_purple.jpg" },
  blue:   { name:"Aqua Sky",        img:"mobby_blue.jpg"   },
  orange: { name:"Sunny Orange",    img:"mobby_orange.jpg" }
};
const ORDER = ["pink","purple","blue","orange"];

let selectedColor = "pink";
let syncing = false;

/* DOM */
const colorCards = document.querySelectorAll('.color-card');
const selectedText1 = document.getElementById('selectedColorText');
const selectedText2 = document.getElementById('selectedColorText2');
const buyRegularBtn = document.getElementById('buyRegular');
const buyStudentBtn = document.getElementById('buyStudent');
const selectedPreviewImg = document.getElementById('selectedPreviewImg');

/* ===== Hero Carousel (3D Rotating Ring) ===== */
const heroCarousel = document.getElementById("heroCarousel");
const heroTrack = document.getElementById("heroTrack");
const heroDots = document.getElementById("heroDots");
const heroCaption = document.getElementById("heroCaption");
const prevBtn = heroCarousel.querySelector(".carousel-btn.prev");
const nextBtn = heroCarousel.querySelector(".carousel-btn.next");

const heroSlides = [...heroTrack.querySelectorAll(".carousel-slide")];
const n = heroSlides.length;
const angle = 360 / n;

let heroIndex = ORDER.indexOf(selectedColor);
let currentRot = -heroIndex * angle;
let ringRadius = 220;

function mod(a, m){ return ((a % m) + m) % m; }
function degToRad(d){ return d * Math.PI / 180; }

// 角度を-360度から0度の範囲に正規化
function normalizeAngle(deg){
  deg = deg % 360;
  if(deg > 0) deg -= 360;
  return deg;
}

// 最短経路で角度を計算（-180度から180度の範囲で）
function getShortestRotationAngle(fromIndex, toIndex, angleStep, currentAngle){
  const fromAngle = -fromIndex * angleStep;
  const toAngle = -toIndex * angleStep;
  
  // 現在の角度を基準に、目標角度への最短経路を計算
  let diff = toAngle - currentAngle;
  
  // -180度から180度の範囲に調整（最短経路）
  while(diff > 180) diff -= 360;
  while(diff < -180) diff += 360;
  
  return currentAngle + diff;
}

// ホットスポットのハンドラーをグローバルに保存
const hotspotHandlers = new Map();

function renderHeroDots(){
  heroDots.innerHTML = "";
  ORDER.forEach((key, i) => {
    const b = document.createElement("button");
    b.type = "button";
    b.className = "carousel-dot" + (i === heroIndex ? " active" : "");
    b.setAttribute("aria-label", `${COLOR_META[key].name} を表示`);
    b.addEventListener("click", () => setHeroIndex(i, true));
    heroDots.appendChild(b);
  });
}

function layoutRing(){
  const slide = heroSlides[0];
  const w = slide ? slide.getBoundingClientRect().width : 330;
  ringRadius = Math.round((w/2) / Math.tan(Math.PI / n) + (w * 0.25));

  heroSlides.forEach((s, i) => {
    const h = s.getBoundingClientRect().height || w;
    s.style.transform =
      `translate(${-w/2}px, ${-h/2}px) rotateY(${i * angle}deg) translateZ(${ringRadius}px)`;
    
    // ホットスポットとシャッターを追加（まだない場合）
    const illustration = s.querySelector('.hero-illustration');
    if(illustration && !illustration.querySelector('.carousel-eye-hotspot')){
      console.log('[DEBUG] ホットスポットを追加します, slide index:', i);
      const hotspot = document.createElement('button');
      hotspot.className = 'carousel-eye-hotspot';
      hotspot.setAttribute('aria-label', '右目をタップして覗く');
      hotspot.type = 'button';
      
      const shutter = document.createElement('div');
      shutter.className = 'carousel-eye-shutter';
      shutter.setAttribute('aria-hidden', 'true');
      
      illustration.appendChild(hotspot);
      illustration.appendChild(shutter);
      console.log('[DEBUG] ホットスポットとシャッターを追加しました, hotspot:', hotspot, 'shutter:', shutter);
      
      // pointerdownで直接処理（clickイベントに頼らない）
      const handleHotspotPointerDown = (e) => {
        console.log('[DEBUG] カルーセルホットスポットがpointerdownされました', e.target);
        e.stopPropagation();
        e.stopImmediatePropagation();
        e.preventDefault();
        
        // シャッターアニメーション
        shutter.classList.remove('play');
        void shutter.offsetWidth;
        shutter.classList.add('play');
        console.log('[DEBUG] シャッターアニメーション開始');
        
        // ビューファインダーを開く
        setTimeout(() => {
          console.log('[DEBUG] openViewfinderを呼び出します, type:', typeof window.openViewfinder);
          if(typeof window.openViewfinder === 'function'){
            console.log('[DEBUG] openViewfinder実行');
            window.openViewfinder(shutter);
          } else {
            console.error('[DEBUG] openViewfinderが関数ではありません:', window.openViewfinder);
          }
        }, 180);
      };
      
      // ハンドラーをマップに保存（heroCarouselのpointerdownから呼び出せるように）
      hotspotHandlers.set(hotspot, handleHotspotPointerDown);
      
      // pointerdownで直接処理（capture phaseで先に処理）
      hotspot.addEventListener('pointerdown', handleHotspotPointerDown, true);
      // clickも一応ハンドリング（ブラウザ差異対策）
      hotspot.addEventListener('click', (e) => {
        console.log('[DEBUG] カルーセルホットスポットがclickされました');
        e.stopPropagation();
        e.stopImmediatePropagation();
        e.preventDefault();
        handleHotspotPointerDown(e);
      }, true);
      
      // タッチイベントも追加（モバイル対応）
      hotspot.addEventListener('touchend', (e) => {
        console.log('[DEBUG] カルーセルホットスポットがタッチされました');
        e.stopPropagation();
        e.stopImmediatePropagation();
        e.preventDefault();
        
        shutter.classList.remove('play');
        void shutter.offsetWidth;
        shutter.classList.add('play');
        
        setTimeout(() => {
          if(typeof window.openViewfinder === 'function'){
            window.openViewfinder(shutter);
          }
        }, 180);
      }, true);
      
      // テスト用：ホットスポットがクリック可能か確認
      console.log('[DEBUG] ホットスポットのスタイル:', window.getComputedStyle(hotspot).pointerEvents);
      console.log('[DEBUG] ホットスポットの位置:', hotspot.getBoundingClientRect());
    }
  });

  updateRing(true);
}

function updateRing(skipTransition=false){
  const key = ORDER[heroIndex];

  if(skipTransition) heroTrack.style.transition = "none";
  else heroTrack.style.transition = "transform 0.7s var(--ease-soft)";

  // 目標角度を計算
  const targetAngle = -heroIndex * angle;
  
  if(!skipTransition){
    // 最短経路で回転（逆向きの1回転を防ぐ）
    let diff = targetAngle - currentRot;
    
    // -180度から180度の範囲に調整（最短経路）
    while(diff > 180) diff -= 360;
    while(diff < -180) diff += 360;
    
    currentRot = currentRot + diff;
  } else {
    // 初期化時は直接設定
    currentRot = targetAngle;
  }
  
  // ★ 修正：currentRotを正規化（-360〜0の範囲に収める）
  // 念のため-360〜0の範囲に正規化
  while(currentRot < -360) currentRot += 360;
  while(currentRot > 0) currentRot -= 360;
  
  heroTrack.style.transform = `translate(-50%, -50%) rotateY(${currentRot}deg)`;

  heroSlides.forEach((s, i) => {
    const world = i * angle + currentRot;
    const frontness = Math.cos(degToRad(world));
    s.classList.toggle("dim", frontness < 0.4);
    s.style.zIndex = String(Math.round(1000 * (frontness + 1)));
  });

  if(heroDots.children.length){
    [...heroDots.children].forEach((d, i) => d.classList.toggle("active", i === heroIndex));
  }
  if(heroCaption) heroCaption.textContent = COLOR_META[key].name;

  if(skipTransition){
    requestAnimationFrame(() => { heroTrack.style.transition = "transform 0.7s var(--ease-soft)"; });
  }
}

function setHeroIndex(i, fromUser){
  heroIndex = mod(i, n);
  updateRing(false);

  if(fromUser){
    syncing = true;
    setSelectedColor(ORDER[heroIndex]);
    syncing = false;
  }
}

function setHeroByColor(colorKey){
  const idx = ORDER.indexOf(colorKey);
  if(idx < 0) return;
  heroIndex = idx;
  updateRing(false);
}

prevBtn.addEventListener("click", () => setHeroIndex(heroIndex - 1, true));
nextBtn.addEventListener("click", () => setHeroIndex(heroIndex + 1, true));
heroSlides.forEach((slide, i) => {
  slide.addEventListener("click", (e) => {
    // ホットスポットやボタンのクリックは無視
    const clickedHotspot = e.target.closest('.carousel-eye-hotspot');
    const clickedBtn = e.target.closest('.carousel-btn');
    if(clickedHotspot || clickedBtn) {
      console.log('[DEBUG] スライドクリック: ホットスポットまたはボタンがクリックされたため無視');
      return;
    }
    console.log('[DEBUG] スライドクリック: スライドを切り替えます');
    setHeroIndex(i, true);
  });
});

let startX = 0, startRot = 0, dragging = false, isDragged = false;

heroCarousel.addEventListener("pointerdown", (e) => {
  console.log('[DEBUG] heroCarousel pointerdown:', e.target, e.clientX, e.clientY);
  
  // クリック位置からホットスポットを検出（3D変換の影響を回避）
  const allHotspots = heroCarousel.querySelectorAll('.carousel-eye-hotspot');
  let clickedHotspot = null;
  
  for(const hotspot of allHotspots) {
    const rect = hotspot.getBoundingClientRect();
    const x = e.clientX;
    const y = e.clientY;
    
    // ホットスポットの領域内かチェック
    if(x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
      // 円形の領域をチェック
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      const radius = Math.max(rect.width, rect.height) / 2;
      const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
      
      if(distance <= radius) {
        clickedHotspot = hotspot;
        console.log('[DEBUG] ホットスポットが検出されました:', hotspot, 'distance:', distance.toFixed(1), 'radius:', radius.toFixed(1));
        break;
      }
    }
  }
  
  if(clickedHotspot) {
    console.log('[DEBUG] heroCarousel pointerdown: ホットスポットがクリックされました', clickedHotspot);
    e.stopPropagation();
    e.preventDefault();
    
    // ホットスポットのハンドラーを直接呼び出す
    const handler = hotspotHandlers.get(clickedHotspot);
    if(handler) {
      handler(e);
    } else {
      console.warn('[DEBUG] ホットスポットのハンドラーが見つかりません');
    }
    return;
  }
  
  // ボタンのクリックは無視
  const isBtn = e.target.closest('.carousel-btn');
  if(isBtn) {
    console.log('[DEBUG] pointerdown: ボタンがクリックされたため無視');
    return;
  }
  
  dragging = true; isDragged = false;
  startX = e.clientX;
  // ドラッグ開始時の角度を正規化して保存
  startRot = normalizeAngle(currentRot);
  heroTrack.style.transition = "none";
  if(heroCarousel.setPointerCapture) heroCarousel.setPointerCapture(e.pointerId);
  e.preventDefault();
});

heroCarousel.addEventListener("pointermove", (e) => {
  if(!dragging) return;
  const dx = e.clientX - startX;
  if(Math.abs(dx) > 5) isDragged = true;

  const rot = startRot + dx * 0.2;
  // ドラッグ中は角度をそのまま使用（スナップ時に正規化）
  currentRot = rot;
  heroTrack.style.transform = `translate(-50%, -50%) rotateY(${rot}deg)`;
  e.preventDefault();
});

heroCarousel.addEventListener("pointerup", (e) => {
  if(!dragging) return;
  dragging = false;

  if(isDragged){
    // スナップ計算前に角度を正規化（-360〜0度の範囲に収める）
    currentRot = normalizeAngle(currentRot);
    const normalizedRot = currentRot;
    const snapped = mod(Math.round((-normalizedRot) / angle), n);
    setHeroIndex(snapped, true);
  }
  isDragged = false;
  if(heroCarousel.releasePointerCapture) heroCarousel.releasePointerCapture(e.pointerId);
});

/* 初期化 */
renderHeroDots();
// layoutRing()はビューファインダー初期化後に呼ぶ（ホットスポットのクリックイベント設定のため）
// 初期レイアウトは後で実行
window.addEventListener("resize", () => layoutRing(), { passive:true });

/* 選択色の反映 */
function setSelectedColor(key){
  if(!COLOR_META[key]) return;
  selectedColor = key;

  colorCards.forEach(card => {
    card.classList.toggle('selected', card.dataset.color === key);
  });

  const meta = COLOR_META[key];
  if(selectedText1) selectedText1.textContent = meta.name;
  if(selectedText2) selectedText2.textContent = meta.name;

  if(selectedPreviewImg){
    selectedPreviewImg.src = meta.img;
    selectedPreviewImg.alt = `Mobby ${meta.name}`;
  }

  if(!syncing) setHeroByColor(key);
}

function goBuy(url){
  if(!url || url.trim().length === 0){
    alert('Stripeの購入リンク（STRIPE_URLS）をコードに入れてください。');
    return;
  }
  window.open(url, '_blank', 'noopener,noreferrer');
}

buyRegularBtn && buyRegularBtn.addEventListener('click', (e) => {
  e.preventDefault();
  goBuy(STRIPE_URLS.regular[selectedColor]);
});

buyStudentBtn && buyStudentBtn.addEventListener('click', (e) => {
  e.preventDefault();
  goBuy(STRIPE_URLS.student[selectedColor] || STRIPE_URLS.regular[selectedColor]);
});

colorCards.forEach(card => {
  card.addEventListener('click', () => setSelectedColor(card.dataset.color));
  card.addEventListener('keydown', (e) => {
    if(e.key === 'Enter' || e.key === ' '){
      e.preventDefault();
      setSelectedColor(card.dataset.color);
    }
  });
});

/* 初期描画 */
setHeroByColor(selectedColor);
syncing = true;
setSelectedColor(selectedColor);
syncing = false;

/* smooth scroll */
document.addEventListener('click', (e) => {
  const a = e.target.closest('a[href^="#"]');
  if(!a) return;
  const id = a.getAttribute('href');
  if(id.length <= 1) return;
  const el = document.querySelector(id);
  if(!el) return;
  e.preventDefault();
  el.scrollIntoView({ behavior:'smooth', block:'start' });
});

/* Splash (Matter.js) */
const ICON_URLS   = ['icon1.png','icon2.png','icon3.png','icon4.png'];
const ICON_SIZE   = 150;
const SPAWN_RATE  = 100;
const TOTAL_ICONS = 50;

const Engine    = Matter.Engine;
const Render    = Matter.Render;
const Runner    = Matter.Runner;
const Bodies    = Matter.Bodies;
const Composite = Matter.Composite;
const Body      = Matter.Body;

const splashElement = document.getElementById('splash-screen');
const mainContent   = document.getElementById('main-content');

const engine = Engine.create();
const world  = engine.world;

let width  = window.innerWidth;
let height = window.innerHeight;

const render = Render.create({
  element: splashElement,
  engine: engine,
  options: { width, height, background: 'transparent', wireframes: false }
});

const wallOptions = { isStatic:true, render:{ visible:false } };
const floor = Bodies.rectangle(width/2, height+50, width+200, 100, wallOptions);
const leftWall = Bodies.rectangle(-60, height/2, 120, height+200, wallOptions);
const rightWall = Bodies.rectangle(width+60, height/2, 120, height+200, wallOptions);
Composite.add(world, [floor, leftWall, rightWall]);

function preloadImages(urls){
  const tasks = urls.map(url => new Promise(resolve => {
    const img = new Image();
    img.onload  = () => resolve({ url, ok:true });
    img.onerror = () => resolve({ url, ok:false });
    img.src = url;
  }));
  return Promise.all(tasks);
}

let AVAILABLE_ICON_URLS = [];
let count = 0;
let dropTimer = null;

function startDropping(){
  dropTimer = setInterval(() => {
    if(count >= TOTAL_ICONS){ clearInterval(dropTimer); return; }

    const xPos = Math.random() * (width - 120) + 60;
    const hasSprite = AVAILABLE_ICON_URLS.length > 0;
    const texture = hasSprite ? AVAILABLE_ICON_URLS[Math.floor(Math.random()*AVAILABLE_ICON_URLS.length)] : null;

    const opts = { restitution:0.55, friction:0.08, frictionAir:0.03, render:{} };

    if(hasSprite){
      opts.render.sprite = { texture, xScale: ICON_SIZE/512, yScale: ICON_SIZE/512 };
    }else{
      const fallbackColors = ['#8FD7FF', '#F7A7C6', '#FFA24A', '#9C7BFF'];
      opts.render.fillStyle = fallbackColors[Math.floor(Math.random()*fallbackColors.length)];
      opts.render.strokeStyle = 'rgba(255,255,255,0.35)';
      opts.render.lineWidth = 2;
    }

    const icon = Bodies.circle(xPos, -60, ICON_SIZE/2, opts);
    Composite.add(world, icon);
    count++;
  }, SPAWN_RATE);
}

Render.run(render);
const runner = Runner.create();
Runner.run(runner, engine);

preloadImages(ICON_URLS).then(results => {
  AVAILABLE_ICON_URLS = results.filter(r => r.ok).map(r => r.url);
  startDropping();
});

splashElement && splashElement.addEventListener('click', () => {
  if(dropTimer) clearInterval(dropTimer);

  const bodies = Composite.allBodies(world);
  bodies.forEach(body => {
    if(!body.isStatic){
      const force = 0.5 * body.mass;
      Body.applyForce(body, body.position, {
        x:(Math.random()-0.5)*force,
        y:(Math.random()-1.5)*force
      });
    }
  });

  setTimeout(() => {
    splashElement.classList.add('hidden');
    mainContent.classList.add('visible');
    document.body.style.overflowY = 'auto';
    initScrollObserver();
    if(stickyCta) stickyCta.style.display = 'block';

    setTimeout(() => {
      Render.stop(render);
      Runner.stop(runner);
      engine.enabled = false;
      splashElement.remove();
    }, 1200);
  }, 500);
});

window.addEventListener('resize', () => {
  width  = window.innerWidth;
  height = window.innerHeight;

  render.canvas.width = width;
  render.canvas.height = height;
  render.options.width = width;
  render.options.height = height;

  Body.setPosition(floor, { x: width/2, y: height+50 });
  Body.setPosition(leftWall, { x: -60, y: height/2 });
  Body.setPosition(rightWall, { x: width+60, y: height/2 });
}, { passive:true });

/* ===== Retro Camera Demo (Overlay) ===== */
// ビューファインダーを開く関数をグローバルに公開（先に定義）
window.openViewfinder = null;

(() => {
  const overlay  = document.getElementById('vfOverlay');
  const closeBtn = document.getElementById('vfClose');
  const backdrop = document.getElementById('vfBackdrop');

  const viewfinder = document.getElementById('rcViewfinder');
  const container  = document.getElementById('rcPhotoContainer');
  const snapBtn    = document.getElementById('rcSnap');
  const counterEl  = document.getElementById('vfCounter');

  if(!overlay || !closeBtn || !backdrop || !viewfinder || !container || !snapBtn || !counterEl) return;

  // スクロール復元
  let prevBodyOverflow = '';
  let prevBodyOverflowY = '';
  let prevHtmlOverflow = '';

  // 初期5枚（ローカル画像で安定運用）
  const SEED = [
    "mobby_pink.jpg",
    "mobby_purple.jpg",
    "mobby_blue.jpg",
    "mobby_orange.jpg",
    "mobby_pink.jpg"
  ];
  let photos = SEED.map((url, i) => ({ id: i + 1, url }));

  let dustMade = false;

  function updateCounter(){
    counterEl.textContent = `${photos.length} / 5`;
  }

  function renderPhotos(){
    const existing = Array.from(container.children);

    photos.forEach((photo, index) => {
      let el = document.getElementById(`rc-p-${photo.id}`);

      if(!el){
        el = document.createElement('div');
        el.id = `rc-p-${photo.id}`;
        el.className = 'rc-polaroid rc-age-0';
        el.style.opacity = '0';

        const img = document.createElement('img');
        img.src = photo.url;
        img.alt = `photo ${index + 1}`;
        img.draggable = false;

        el.appendChild(img);
        container.appendChild(el);

        setTimeout(() => { el.style.opacity = '1'; }, 50);
      }

      el.classList.remove('rc-age-0','rc-age-1','rc-age-2','rc-age-3','rc-age-4');
      el.classList.add(`rc-age-${index}`);
    });

    const currentIds = photos.map(p => `rc-p-${p.id}`);
    existing.forEach(el => {
      if(!currentIds.includes(el.id)){
        el.style.opacity = '0';
        el.style.transform = 'scale(0.5)';
        setTimeout(() => el.remove(), 800);
      }
    });

    updateCounter();
  }

  // “エモ”フラッシュ（やわらかい光漏れ）
  function addFlashEffect(){
    const flash = document.createElement('div');
    flash.style.position = 'absolute';
    flash.style.inset = '0';
    flash.style.background =
      'radial-gradient(circle at center, #fff 0%, rgba(255,255,255,0.8) 30%, rgba(255,255,255,0) 65%)';
    flash.style.opacity = '0.92';
    flash.style.zIndex = '200';
    flash.style.pointerEvents = 'none';
    flash.style.transition = 'opacity 0.25s ease-out';

    viewfinder.appendChild(flash);

    requestAnimationFrame(() => {
      requestAnimationFrame(() => { flash.style.opacity = '0'; });
    });

    setTimeout(() => flash.remove(), 350);
  }

  function createDust(){
    if(dustMade) return;
    dustMade = true;
    for(let i=0;i<40;i++){
      const d = document.createElement('div');
      d.className = 'rc-dust';
      d.style.left = `${Math.random()*100}%`;
      d.style.top  = `${Math.random()*100}%`;
      const size = Math.random() * 2;
      d.style.width = `${size}px`;
      d.style.height = `${size}px`;
      d.style.opacity = String(Math.random() * 0.5);
      viewfinder.appendChild(d);
    }
  }

// ▼ 追加：デモ用の画像プール（毎回ここから回す）
const DEMO_POOL = [
  "mobby_pink.jpg",
  "mobby_purple.jpg",
  "mobby_blue.jpg",
  "mobby_orange.jpg",
];
let demoCursor = 0;

// ▼ 置き換え：takePhoto()
function takePhoto(){
  const newId = Date.now();

  // 毎回違う画像になるようにローテーション
  const baseUrl = DEMO_POOL[demoCursor % DEMO_POOL.length];
  demoCursor++;

  // 同じファイルでもブラウザキャッシュで見た目が変わらない事故を防ぐ（保険）
  const url = `${baseUrl}?cb=${newId}`;

  photos.unshift({ id: newId, url });
  if(photos.length > 5) photos.pop();

  renderPhotos();
  addFlashEffect();
}


  function open(){
    overlay.classList.add('is-open');
    overlay.setAttribute('aria-hidden', 'false');

    prevBodyOverflow  = document.body.style.overflow;
    prevBodyOverflowY = document.body.style.overflowY;
    prevHtmlOverflow  = document.documentElement.style.overflow;

    document.body.style.overflow = 'hidden';
    document.body.style.overflowY = 'hidden';
    document.documentElement.style.overflow = 'hidden';

    createDust();
    renderPhotos();
  }

  function close(){
    overlay.classList.remove('is-open');
    overlay.setAttribute('aria-hidden', 'true');

    document.body.style.overflow  = prevBodyOverflow;
    document.body.style.overflowY = prevBodyOverflowY;
    document.documentElement.style.overflow = prevHtmlOverflow;
  }

  // ビューファインダーを開く関数をグローバルに公開
  window.openViewfinder = function(shutterElement = null){
    console.log('[DEBUG] openViewfinderが呼ばれました, shutterElement:', shutterElement);
    // シャッターアニメーション（指定された要素またはデフォルトのeyeShutter）
    const shutter = shutterElement || eyeShutter;
    console.log('[DEBUG] 使用するshutter:', shutter);
    if(shutter){
      shutter.classList.remove('play');
      void shutter.offsetWidth;
      shutter.classList.add('play');
      console.log('[DEBUG] シャッターアニメーション実行');
    } else {
      console.warn('[DEBUG] shutter要素が見つかりません');
    }
    setTimeout(() => {
      console.log('[DEBUG] open関数を呼び出します');
      open();
    }, 180);
  };
  console.log('[DEBUG] window.openViewfinderが定義されました:', typeof window.openViewfinder);


  // snap / close
  snapBtn.addEventListener('click', takePhoto);
  closeBtn.addEventListener('click', close);
  backdrop.addEventListener('click', close);
  window.addEventListener('keydown', (e) => {
    if(!overlay.classList.contains('is-open')) return;
    if(e.key === 'Escape') close();
  });
})();

// ビューファインダー初期化後にカルーセルのレイアウトを実行（ホットスポットのクリックイベント設定のため）
console.log('[DEBUG] layoutRingを実行します, openViewfinder:', typeof window.openViewfinder);
layoutRing();
console.log('[DEBUG] layoutRing実行完了');

/* ===== ポップアップ制御 ===== */
function openPopup(popupId){
  const popup = document.getElementById(popupId);
  if(!popup) return;
  popup.classList.add('is-open');
  popup.setAttribute('aria-hidden', 'false');
  document.body.style.overflow = 'hidden';
}

function closePopup(popupId){
  const popup = document.getElementById(popupId);
  if(!popup) return;
  popup.classList.remove('is-open');
  popup.setAttribute('aria-hidden', 'true');
  document.body.style.overflow = '';
}

// ポップアップボタンのイベント
document.getElementById('openMessagePopup')?.addEventListener('click', () => openPopup('messagePopup'));
document.getElementById('openColorsPopup')?.addEventListener('click', () => openPopup('colorsPopup'));
document.getElementById('openPricePopup')?.addEventListener('click', () => openPopup('pricePopup'));
document.getElementById('openFaqPopup')?.addEventListener('click', () => openPopup('faqPopup'));

// 閉じるボタンのイベント
document.getElementById('closeMessagePopup')?.addEventListener('click', () => closePopup('messagePopup'));
document.getElementById('closeColorsPopup')?.addEventListener('click', () => closePopup('colorsPopup'));
document.getElementById('closePricePopup')?.addEventListener('click', () => closePopup('pricePopup'));
document.getElementById('closeFaqPopup')?.addEventListener('click', () => closePopup('faqPopup'));

// オーバーレイクリックで閉じる
document.getElementById('messagePopup')?.addEventListener('click', (e) => {
  if(e.target.id === 'messagePopup') closePopup('messagePopup');
});
document.getElementById('colorsPopup')?.addEventListener('click', (e) => {
  if(e.target.id === 'colorsPopup') closePopup('colorsPopup');
});
document.getElementById('pricePopup')?.addEventListener('click', (e) => {
  if(e.target.id === 'pricePopup') closePopup('pricePopup');
});
document.getElementById('faqPopup')?.addEventListener('click', (e) => {
  if(e.target.id === 'faqPopup') closePopup('faqPopup');
});

// ESCキーで閉じる
window.addEventListener('keydown', (e) => {
  if(e.key === 'Escape'){
    if(document.getElementById('messagePopup')?.classList.contains('is-open')) closePopup('messagePopup');
    if(document.getElementById('colorsPopup')?.classList.contains('is-open')) closePopup('colorsPopup');
    if(document.getElementById('pricePopup')?.classList.contains('is-open')) closePopup('pricePopup');
    if(document.getElementById('faqPopup')?.classList.contains('is-open')) closePopup('faqPopup');
  }
});

// ポップアップ間の遷移
document.getElementById('openPriceFromColors')?.addEventListener('click', () => {
  closePopup('colorsPopup');
  setTimeout(() => openPopup('pricePopup'), 200);
});
document.getElementById('openColorsFromFaq')?.addEventListener('click', () => {
  closePopup('faqPopup');
  setTimeout(() => openPopup('colorsPopup'), 200);
});

  </script>
</body>
</html>