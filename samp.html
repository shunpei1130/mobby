<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retro Camera - Memory Stack</title>
    <style>
        /* --- 基本設定 --- */
        :root {
            --bg-color: #0f0f11;
            --frame-color: #1a1a1c;
            --photo-border: #fdfbf7;
        }

        body {
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            font-family: 'Courier New', monospace;
            color: #555;
        }

        /* --- カメラ本体 --- */
        .camera-body {
            position: relative;
            width: 600px;
            height: 600px;
            background-color: var(--frame-color);
            box-shadow: inset 0 0 50px #000;
            border-radius: 4px;
            overflow: hidden;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            margin-bottom: 20px;
        }

        /* --- ファインダー（暗室） --- */
        .viewfinder {
            position: absolute;
            top: 50px;
            left: 50px;
            right: 50px;
            bottom: 50px;
            background-color: #050505;
            box-shadow: inset 0 0 80px rgba(0,0,0,1);
            overflow: hidden;
            perspective: 1000px; /* 奥行き */
        }

        /* --- 写真コンテナ --- */
        .photo-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        /* --- ポラロイド共通スタイル --- */
        .polaroid {
            position: absolute;
            background-color: var(--photo-border);
            padding: 10px 10px 35px 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
            /* 位置とスタイルの変化を滑らかにする */
            transition: all 0.8s cubic-bezier(0.25, 0.8, 0.25, 1);
            width: 140px;
            will-change: transform, opacity, filter;
        }

        .polaroid img {
            display: block;
            width: 100%;
            height: 140px; /* 正方形にトリミング */
            object-fit: cover;
            filter: grayscale(0.2) contrast(1.1);
        }

        /* === 年齢（新旧）による状態変化 === */

        /* Age 0: 最新 (中央、鮮やか、一番手前) */
        .age-0 {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(2deg) scale(1.1);
            z-index: 50;
            opacity: 1;
            filter: contrast(1.1) brightness(1.1);
            box-shadow: 0 20px 50px rgba(0,0,0,0.9);
        }

        /* Age 1: 少し前 (左上、少し傾く) */
        .age-1 {
            top: 40px;
            left: 30px;
            transform: rotate(-6deg) scale(0.95);
            z-index: 40;
            opacity: 0.95;
            filter: sepia(0.2) contrast(1);
        }

        /* Age 2: もう少し前 (右上、セピアが強まる) */
        .age-2 {
            top: 30px;
            right: 30px;
            transform: rotate(4deg) scale(0.9);
            z-index: 30;
            opacity: 0.85;
            filter: sepia(0.4) brightness(0.9);
        }

        /* Age 3: 古い (左下、暗くなる) */
        .age-3 {
            bottom: 60px;
            left: 40px;
            transform: rotate(8deg) scale(0.85);
            z-index: 20;
            opacity: 0.7;
            filter: sepia(0.6) grayscale(0.5) brightness(0.8);
        }

        /* Age 4: 最古 (右下、消えそう、ボケる) */
        .age-4 {
            bottom: 40px;
            right: 20px;
            transform: rotate(-5deg) scale(0.8);
            z-index: 10;
            opacity: 0.4; /* 半透明 */
            filter: sepia(0.8) grayscale(0.8) blur(2px); /* ぼやける */
        }

        /* --- エフェクト類（オーバーレイ） --- */
        .overlay-texture {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 100;
            mix-blend-mode: overlay;
            opacity: 0.5;
            background: radial-gradient(circle, transparent 30%, #000 130%);
        }

        .dust {
            position: absolute;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            pointer-events: none;
            z-index: 101;
        }

        .lens-reflection {
            position: absolute;
            bottom: -80px; left: 50%; transform: translateX(-50%);
            width: 80%; height: 150px;
            background: radial-gradient(ellipse at center, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
            z-index: 110;
            border-top: 1px solid rgba(255,255,255,0.1);
            filter: blur(2px);
            pointer-events: none;
        }

        /* --- コントロールボタン --- */
        .controls {
            margin-top: 20px;
            text-align: center;
        }

        button {
            background: #cc3333;
            color: #fff;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(204, 51, 51, 0.4);
            font-family: sans-serif;
            font-weight: bold;
            letter-spacing: 1px;
            transition: transform 0.1s;
        }

        button:active {
            transform: scale(0.95);
            background: #aa2222;
        }
        
        .hint {
            margin-top: 10px;
            font-size: 12px;
            opacity: 0.6;
        }

    </style>
</head>
<body>

    <div class="camera-body">
        <div class="viewfinder" id="viewfinder">
            <div class="photo-layer" id="photoContainer"></div>

            <div class="overlay-texture"></div>
            <div class="lens-reflection"></div>
        </div>
    </div>

    <div class="controls">
        <button onclick="takePhoto()">SNAP SHUTTER</button>
        <div class="hint">新しい写真を撮ると、古い写真は隅へ追いやられ、やがて消えます。</div>
    </div>

    <script>
        // 画像データの管理（最大5枚）
        let photos = [
            { id: 1, url: 'https://picsum.photos/id/64/200/200' },
            { id: 2, url: 'https://picsum.photos/id/16/200/200' },
            { id: 3, url: 'https://picsum.photos/id/338/200/200' },
            { id: 4, url: 'https://picsum.photos/id/40/200/200' },
            { id: 5, url: 'https://picsum.photos/id/250/200/200' }
        ];

        const container = document.getElementById('photoContainer');

        // 写真を描画する関数
        function renderPhotos() {
            // 現在のDOMをクリア（※アニメーションを維持するため、実際はReact/VueのようなDiff更新が理想ですが、
            // ここではシンプルにID管理で既存要素のクラスを書き換える方式をとります）
            
            // 既存の要素を取得
            const existingElements = Array.from(container.children);
            
            photos.forEach((photo, index) => {
                let el = document.getElementById(`p-${photo.id}`);
                
                // 新しい写真の場合、要素を作成
                if (!el) {
                    el = document.createElement('div');
                    el.id = `p-${photo.id}`;
                    el.classList.add('polaroid');
                    
                    // 初期位置（画面外または中央からふわっと出る演出）
                    // ここでは中央（age-0と同じ位置）からスタートさせると自然
                    el.classList.add('age-0'); 
                    el.style.opacity = '0'; // 最初は透明
                    
                    const img = document.createElement('img');
                    img.src = photo.url;
                    el.appendChild(img);
                    container.appendChild(el);

                    // 少し待ってから不透明度を上げる（フェードイン）
                    setTimeout(() => el.style.opacity = '1', 50);
                }

                // クラス（位置・スタイル）を更新
                // index 0 = 最新, index 4 = 最古
                // すべてのageクラスを削除してから、新しいageクラスを付与
                el.classList.remove('age-0', 'age-1', 'age-2', 'age-3', 'age-4');
                el.classList.add(`age-${index}`);
            });

            // 配列に含まれなくなった（古すぎて消えた）DOM要素を削除
            const currentIds = photos.map(p => `p-${p.id}`);
            existingElements.forEach(el => {
                if (!currentIds.includes(el.id)) {
                    // 消えるアニメーション
                    el.style.opacity = '0';
                    el.style.transform = 'scale(0.5)';
                    setTimeout(() => el.remove(), 800); // 遷移時間後にDOM削除
                }
            });
        }

        // 新しい写真を追加する関数
        function takePhoto() {
            const newId = Date.now(); // ユニークID
            const randomNum = Math.floor(Math.random() * 1000);
            
            const newPhoto = {
                id: newId,
                url: `https://picsum.photos/seed/${randomNum}/200/200`
            };

            // 配列の先頭に追加
            photos.unshift(newPhoto);

            // 5枚を超えたら末尾を削除
            if (photos.length > 5) {
                photos.pop();
            }

            renderPhotos();
            addFlashEffect();
        }

        // シャッターを切ったときのフラッシュ演出
        function addFlashEffect() {
            const flash = document.createElement('div');
            flash.style.position = 'absolute';
            flash.style.top = '0';
            flash.style.left = '0';
            flash.style.width = '100%';
            flash.style.height = '100%';
            flash.style.backgroundColor = '#fff';
            flash.style.opacity = '0.8';
            flash.style.zIndex = '200';
            flash.style.pointerEvents = 'none';
            flash.style.transition = 'opacity 0.2s ease-out';
            
            document.getElementById('viewfinder').appendChild(flash);
            
            // 次のフレームで透明にする
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    flash.style.opacity = '0';
                });
            });

            setTimeout(() => flash.remove(), 300);
        }

        // --- 埃（ダスト）生成 (前回のコードから流用) ---
        function createDust() {
            const viewfinder = document.getElementById('viewfinder');
            for (let i = 0; i < 40; i++) {
                const dust = document.createElement('div');
                dust.classList.add('dust');
                dust.style.left = `${Math.random() * 100}%`;
                dust.style.top = `${Math.random() * 100}%`;
                const size = Math.random() * 2;
                dust.style.width = `${size}px`;
                dust.style.height = `${size}px`;
                dust.style.opacity = Math.random() * 0.5;
                viewfinder.appendChild(dust);
            }
        }

        // 初期化
        createDust();
        renderPhotos();

    </script>
</body>
</html>